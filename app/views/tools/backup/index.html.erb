<%= render 'admin/admin_bar' %>
<h3>Backup Settings</h3>
<%= form_with(model: @backup_setting, url: tools_backup_index_path, method: :post, local: true) do |f| %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">S3 Configuration</h5>
    </div>
    <div class="card-body">
      <div class="form-group mb-3">
        <%= f.label :s3_enabled, class: "form-label" %>
        <%= f.check_box :s3_enabled, class: "form-check-input ms-2" %>
      </div>

      <div class="form-group mb-3">
        <%= f.label :s3_bucket, "S3 Bucket Name", class: "form-label" %>
        <%= f.text_field :s3_bucket, class: "form-control" %>
      </div>

      <div class="form-group mb-3">
        <%= f.label :s3_region, "S3 Region", class: "form-label" %>
        <%= f.text_field :s3_region, class: "form-control", placeholder: "e.g., us-east-1" %>
      </div>

      <div class="form-group mb-3">
        <%= f.label :s3_endpoint, "S3 Endpoint (Optional)", class: "form-label" %>
        <%= f.text_field :s3_endpoint, class: "form-control", placeholder: "e.g., https://s3.amazonaws.com" %>
        <small class="form-text text-muted">Leave empty for AWS S3. Set for other S3-compatible services.</small>
      </div>

      <div class="form-group mb-3">
        <%= f.label :s3_prefix, "Backup Prefix", class: "form-label" %>
        <%= f.text_field :s3_prefix, class: "form-control", placeholder: "backups" %>
        <small class="form-text text-muted">Directory prefix for backup files in the bucket</small>
      </div>

      <div class="form-group mb-3">
        <%= f.label :s3_access_key_id, "Access Key ID", class: "form-label" %>
        <%= f.text_field :s3_access_key_id, class: "form-control" %>
      </div>

      <div class="form-group mb-3">
        <%= f.label :s3_secret_access_key, "Secret Access Key", class: "form-label" %>
        <%= f.password_field :s3_secret_access_key, class: "form-control" %>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Backup Schedule</h5>
    </div>
    <div class="card-body">
      <div class="form-group mb-3">
        <%= f.label :auto_backup, "Enable Auto Backup", class: "form-label" %>
        <%= f.check_box :auto_backup, class: "form-check-input ms-2" %>
      </div>

      <div class="form-group mb-3">
        <%= f.label :backup_interval_hours, "Backup Interval (hours)", class: "form-label" %>
        <%= f.number_field :backup_interval_hours, min: 1, class: "form-control" %>
      </div>

      <div class="form-group mb-3">
        <%= f.label :backup_retention_days, "Backup Retention (days)", class: "form-label" %>
        <%= f.number_field :backup_retention_days, min: 1, class: "form-control" %>
        <small class="form-text text-muted">Backups older than this will be automatically deleted</small>
      </div>
    </div>
  </div>

  <%= f.submit "Save Settings", class: "btn btn-primary" %>
<% end %>

<% if @backup_setting.persisted? %>
  <div class="card mt-4">
    <div class="card-header">
      <h5 class="mb-0">Actions</h5>
    </div>
    <div class="card-body">

    <span>Data changed since last backup:</span>
    <span class="<%= @backup_setting.data_changed ? 'text-warning' : 'text-success' %>">
      <%= @backup_setting.data_changed ? 'Yes' : 'No' %>
    </span>

      <div class="row">
        <div class="col-md-6">
          <%= button_to "Backup Now", perform_backup_tools_backup_index_path, method: :post, class: "btn btn-primary" %>
        </div>
      </div>
      
      <% if @backup_setting.last_backup_at.present? %>
        <p class="mt-3 mb-0">
          <strong>Last backup:</strong> 
          <span class="text-muted"><%= @backup_setting.last_backup_at.strftime('%Y-%m-%d %H:%M:%S') %></span>
        </p>
      <% end %>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Backup List</h5>
      <button class="btn btn-sm btn-outline-primary" onclick="refreshBackupList()">Refresh</button>
    </div>
    <div class="card-body">
      <div id="backup-list" class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Backup File</th>
              <th>Size</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="backup-list-body">
            <tr>
              <td colspan="4" class="text-center">Loading backups...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-header">
      <h5 class="mb-0">Backup History</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Time</th>
              <th>Level</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <% @activity_logs.each do |log| %>
              <tr class="<%= case log.level&.to_sym
                            when :error then 'table-danger'
                            when :warn then 'table-warning'
                            when :info then 'table-success'
                            else ''
                            end %>">
                <td><%= log.created_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
                <td><span class="badge <%= case log.level&.to_sym
                                         when :error then 'bg-danger'
                                         when :warn then 'bg-warning'
                                         when :info then 'bg-success'
                                         else 'bg-secondary'
                                         end %>">
                  <%= log.level&.capitalize || 'Unknown' %>
                </span></td>
                <td><%= log.description %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    function refreshBackupList() {
      fetch('/tools/backup/list_backups')
        .then(response => response.json())
        .then(backups => {
          const tbody = document.getElementById('backup-list-body');
          tbody.innerHTML = '';
          
          backups.forEach(backup => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${backup.key}</td>
              <td>${(backup.size / 1024 / 1024).toFixed(2)} MB</td>
              <td>${new Date(backup.last_modified).toLocaleString()}</td>
              <td>
                <form action="/tools/backup/restore" method="post" style="display: inline;">
                  <input type="hidden" name="authenticity_token" value="${document.querySelector('meta[name="csrf-token"]').content}">
                  <input type="hidden" name="backup_key" value="${backup.key}">
                  <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Are you sure you want to restore this backup? This will overwrite your current database.')">
                    Restore
                  </button>
                </form>
              </td>
            `;
            tbody.appendChild(tr);
          });

          if (backups.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">No backups found</td></tr>';
          }
        })
        .catch(error => {
          console.error('Error fetching backups:', error);
          document.getElementById('backup-list-body').innerHTML = 
            '<tr><td colspan="4" class="text-center text-danger">Error loading backups</td></tr>';
        });
    }

    // Load backup list when page loads
    document.addEventListener('DOMContentLoaded', refreshBackupList);
  </script>
<% end %>