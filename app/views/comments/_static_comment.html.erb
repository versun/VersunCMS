<% comment = comment_item[:data] %>
<% type = comment_item[:type] %>
<% depth = local_assigns[:depth] || 0 %>
<% max_depth = 5 %>

<% 
  border_color = case type
  when 'mastodon' then '#6364FF'
  when 'bluesky' then '#0085FF'
  when 'twitter' then '#1DA1F2'
  else '#333'
  end
%>

<div class="comment" data-comment-id="<%= comment.id %>" style="margin-bottom: <%= depth > 0 ? '0.5rem' : '0.75rem' %>; <%= depth > 0 ? "padding-left: #{depth * 0.75}rem; border-left: 2px solid #e0e0e0; margin-left: 0.25rem;" : '' %>">
  <div style="display: flex; align-items: start; gap: <%= depth > 0 ? '0.375rem' : '0.5rem' %>;">
    <% avatar_size = depth > 0 ? '24px' : '32px' %>
    <% if comment.author_avatar_url.present? %>
      <img src="<%= comment.author_avatar_url %>" alt="<%= comment.author_name %>" style="width: <%= avatar_size %>; height: <%= avatar_size %>; border-radius: 50%; flex-shrink: 0;">
    <% else %>
      <div style="width: <%= avatar_size %>; height: <%= avatar_size %>; border-radius: 50%; background-color: <%= border_color %>; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: <%= depth > 0 ? '0.65rem' : '0.75rem' %>; flex-shrink: 0;">
        <%= comment.author_name.to_s.first.upcase %>
      </div>
    <% end %>
    
    <div style="flex: 1; min-width: 0;">
      <div style="margin-bottom: <%= depth > 0 ? '0.125rem' : '0.25rem' %>;">
        <% if comment.author_url.present? %>
          <strong style="font-size: <%= depth > 0 ? '0.8rem' : '0.875rem' %>; color: #111;"><a href="<%= comment.author_url %>" target="_blank" style="text-decoration: none; color: inherit;"><%= comment.author_name %></a></strong>
        <% else %>
          <strong style="font-size: <%= depth > 0 ? '0.8rem' : '0.875rem' %>; color: #111;"><%= comment.author_name %></strong>
        <% end %>
        
        <% if type != 'local' && comment.author_username.present? %>
          <span style="color: #666; font-size: <%= depth > 0 ? '0.7rem' : '0.8rem' %>; margin-left: 0.25rem;">@<%= comment.author_username %></span>
        <% end %>
        
        <small style="color: #999; margin-left: 0.5rem; font-size: <%= depth > 0 ? '0.7rem' : '0.75rem' %>;">
          <%= ((Time.current - comment.published_at) / 1.day).to_i %> days ago
          <% if type != 'local' %>
            · <a href="<%= comment.url %>" target="_blank" style="color: <%= border_color %>; text-decoration: none;"><%= type.titleize %></a>
          <% end %>
        </small>
      </div>
      
      <div style="color: #333; line-height: <%= depth > 0 ? '1.4' : '1.5' %>; font-size: <%= depth > 0 ? '0.8rem' : '0.875rem' %>; margin-bottom: <%= depth > 0 ? '0.25rem' : '0.5rem' %>;">
        <%= sanitize comment.content, tags: %w[p br a span], attributes: %w[href class rel target] %>
      </div>

      <% if type == 'local' && depth < max_depth %>
        <button 
          type="button" 
          class="reply-button" 
          data-comment-id="<%= comment.id %>"
          style="background: none; border: none; color: #666; font-size: <%= depth > 0 ? '0.7rem' : '0.75rem' %>; cursor: pointer; padding: 0.125rem 0; text-decoration: underline;"
          onclick="showReplyForm(<%= comment.id %>)">
          回复
        </button>
      <% end %>
    </div>
  </div>

  <% if comment.replies.any? %>
    <div class="replies" style="margin-top: <%= depth > 0 ? '0.5rem' : '0.75rem' %>;">
      <% if type == 'local' %>
        <% comment.replies.approved.order(published_at: :asc).each do |reply| %>
          <%= render 'comments/static_comment', comment_item: { type: 'local', data: reply }, depth: depth + 1 %>
        <% end %>
      <% else %>
        <% comment.replies.where(platform: type).order(published_at: :asc).each do |reply| %>
          <%= render 'comments/static_comment', comment_item: { type: type, data: reply }, depth: depth + 1 %>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <% if type == 'local' && depth < max_depth %>
    <div id="reply-form-<%= comment.id %>" class="reply-form-container" style="display: none; margin-top: 0.5rem; margin-left: <%= (depth + 1) * 0.75 + 0.25 %>rem;">
      <%= render 'comments/static_form', comment: Comment.new, parent_id: comment.id %>
    </div>
  <% end %>
</div>

