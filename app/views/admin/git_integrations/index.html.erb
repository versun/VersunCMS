<% content_for :title, "Git Integrations|Admin" %>

<div class="admin-container">
  <h1>Git Integrations</h1>
  <p class="text-muted">配置 Git 提供商的认证信息，用于静态文件部署。</p>

  <div class="admin-toolbar">
    <div class="status-tabs">
      <% @integrations.each do |integration| %>
        <%= link_to integration.display_name, admin_git_integrations_path(provider: integration.provider), class: "status-tab #{@active_provider == integration.provider ? 'active' : ''}" %>
      <% end %>
    </div>
  </div>

  <% @integrations.each do |integration| %>
    <% next unless integration.provider == @active_provider %>
    <div class="form-section compact">
      <h2><%= integration.display_name %></h2>
      <small><%= provider_help_text(integration.provider) %></small>

      <%= form_with(model: integration, url: admin_git_integration_path(integration.provider), method: :patch, id: "git-integration-form-#{integration.provider}") do |f| %>
        <div class="field checkbox">
          <%= f.check_box :enabled, id: "git_integration_enabled_#{integration.provider}" %>
          <%= f.label :enabled, "启用 #{integration.display_name}", for: "git_integration_enabled_#{integration.provider}" %>
        </div>

        <% if integration.requires_server_url? %>
          <div class="field">
            <%= f.label :server_url, "Server URL" %>
            <%= f.text_field :server_url, id: "git_integration_server_url_#{integration.provider}", placeholder: "https://your-gitea-instance.com" %>
            <small>自托管实例的 URL</small>
          </div>
        <% elsif integration.provider == "gitlab" %>
          <div class="field">
            <%= f.label :server_url, "Server URL (Optional)" %>
            <%= f.text_field :server_url, id: "git_integration_server_url_#{integration.provider}", placeholder: "https://gitlab.com" %>
            <small>留空使用 gitlab.com，或输入自托管 GitLab URL</small>
          </div>
        <% end %>

        <% if %w[bitbucket gitea codeberg].include?(integration.provider) %>
          <div class="field">
            <%= f.label :username, username_label(integration.provider) %>
            <%= f.text_field :username, id: "git_integration_username_#{integration.provider}", placeholder: username_placeholder(integration.provider) %>
            <small><%= username_help_text(integration.provider) %></small>
          </div>
        <% end %>

        <div class="field">
          <%= f.label :access_token, token_label(integration.provider) %>
          <%= f.text_field :access_token, type: "password", id: "git_integration_access_token_#{integration.provider}", value: "", placeholder: token_placeholder(integration.provider), autocomplete: "new-password" %>
          <small><%= token_help_text(integration.provider) %>（留空表示不修改）</small>
        </div>

        <div class="form-actions">
          <%= f.submit "保存", class: 'btn btn-primary' %>
          <div id="verify-button-<%= integration.provider %>">
            <%= button_tag "验证连接", type: 'submit', class: 'btn btn-secondary', form: "verify-form-#{integration.provider}", data: { turbo_frame: "_top" } %>
          </div>
        </div>
      <% end %>

      <%= form_with(url: verify_admin_git_integration_path(integration.provider), method: :post, data: { turbo: true, provider: integration.provider }, id: "verify-form-#{integration.provider}") do %>
        <%= hidden_field_tag 'git_integration[server_url]', "", id: "verify_server_url_#{integration.provider}" %>
        <%= hidden_field_tag 'git_integration[username]', "", id: "verify_username_#{integration.provider}" %>
        <%= hidden_field_tag 'git_integration[access_token]', "", id: "verify_access_token_#{integration.provider}" %>
      <% end %>
      <div id="verify-messages-<%= integration.provider %>"></div>
    </div>
  <% end %>
</div>

<% content_for :javascript do %>
<script>
(function() {
  function syncVerifyFields(provider) {
    const accessToken = document.getElementById(`git_integration_access_token_${provider}`)?.value || "";
    const serverUrl = document.getElementById(`git_integration_server_url_${provider}`)?.value || "";
    const username = document.getElementById(`git_integration_username_${provider}`)?.value || "";

    const verifyAccessToken = document.getElementById(`verify_access_token_${provider}`);
    if (verifyAccessToken) verifyAccessToken.value = accessToken;

    const verifyServerUrl = document.getElementById(`verify_server_url_${provider}`);
    if (verifyServerUrl) verifyServerUrl.value = serverUrl;

    const verifyUsername = document.getElementById(`verify_username_${provider}`);
    if (verifyUsername) verifyUsername.value = username;
  }

  document.addEventListener("submit", function(event) {
    const form = event.target;
    if (!(form instanceof HTMLFormElement)) return;
    if (!form.id || !form.id.startsWith("verify-form-")) return;

    const provider = form.dataset.provider;
    if (!provider) return;

    syncVerifyFields(provider);
  }, true);
})();
</script>
<% end %>
