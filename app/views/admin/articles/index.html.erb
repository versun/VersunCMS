<% content_for :title, "Posts|Admin" %>

<div class="admin-articles">
  <div class="admin-toolbar">
    <%= link_to "New Post", new_admin_article_path, class: "btn btn-primary" %>
    
    <div class="status-tabs">
      <%= link_to "All", admin_articles_path, class: "status-tab #{params[:status].blank? ? 'active' : ''}" %>
      <%= link_to "Published", admin_articles_path(status: 'publish'), class: "status-tab #{params[:status] == 'publish' ? 'active' : ''}" %>
      <%= link_to "Draft", admin_articles_path(status: 'draft'), class: "status-tab #{params[:status] == 'draft' ? 'active' : ''}" %>
      <%= link_to "Scheduled", admin_articles_path(status: 'schedule'), class: "status-tab #{params[:status] == 'schedule' ? 'active' : ''}" %>
      <%= link_to "Shared", admin_articles_path(status: 'shared'), class: "status-tab #{params[:status] == 'shared' ? 'active' : ''}" %>
      <%= link_to "Trash", admin_articles_path(status: 'trash'), class: "status-tab #{params[:status] == 'trash' ? 'active' : ''}" %>
    </div>
  </div>

  <div data-controller="batch-selection">
    <!-- Batch Actions Bar -->
    <div data-batch-selection-target="actions" style="display: none; padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px; gap: 10px;">
      <span style="margin-right: 10px;"><strong><span data-batch-selection-target="count">0</span></strong> selected</span>
      
      <%= form_with url: batch_publish_admin_articles_path, method: :post, style: "display: inline;" do |f| %>
        <%= f.button "Publish", type: "submit", class: "btn btn-sm", style: "background: #28a745; color: white;",
            data: { batch_action: "publish" } %>
      <% end %>

      <%= form_with url: batch_unpublish_admin_articles_path, method: :post, style: "display: inline;" do |f| %>
        <%= f.button "Unpublish", type: "submit", class: "btn btn-sm", style: "background: #ffc107; color: black;",
            data: { batch_action: "unpublish" } %>
      <% end %>

      <%= form_with url: batch_destroy_admin_articles_path, method: :post, style: "display: inline;" do |f| %>
        <%= f.button "Delete", type: "submit", class: "btn btn-sm", style: "background: #dc3545; color: white;",
            data: { batch_action: "delete" } %>
      <% end %>

      <button type="button" class="btn btn-sm" style="background: #17a2b8; color: white;"
              data-batch-modal-open="add-tags">Add Tags</button>

      <button type="button" class="btn btn-sm" style="background: #6f42c1; color: white;"
              data-batch-modal-open="crosspost">Crosspost</button>

      <button type="button" class="btn btn-sm" style="background: #fd7e14; color: white;"
              data-batch-modal-open="newsletter">Newsletter</button>
    </div>

    <!-- Batch Add Tags Modal -->
    <div id="batchAddTagsModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
      <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 500px; border-radius: 8px;">
        <h3>批量添加标签</h3>
        <p>请输入要添加的标签（用逗号分隔）：</p>
        <%= form_with url: batch_add_tags_admin_articles_path, method: :post, id: "batchAddTagsForm" do |f| %>
          <%= f.text_field :tag_names, placeholder: "例如: tag1, tag2, tag3", style: "width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;" %>
          <div style="text-align: right;">
            <button type="button" class="btn btn-sm" data-batch-modal-close="add-tags" style="margin-right: 10px;">取消</button>
            <%= f.button "确认", type: "submit", class: "btn btn-sm", style: "background: #17a2b8; color: white;",
                data: { batch_modal_submit: "batchAddTagsForm" } %>
          </div>
        <% end %>
      </div>
    </div>

	    <!-- Batch Crosspost Modal -->
	    <div id="batchCrosspostModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
	      <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 500px; border-radius: 8px;">
	        <h3>批量跨平台发布</h3>
	        <p>请选择要发布的平台：</p>
	        <%= form_with url: batch_crosspost_admin_articles_path, method: :post, id: "batchCrosspostForm" do |f| %>
	          <div style="margin-bottom: 15px;">
	            <label style="display: block; margin-bottom: 8px;">
	              <%= check_box_tag "platforms[]", "mastodon", false, id: "platform_mastodon" %>
	              Mastodon
            </label>
            <label style="display: block; margin-bottom: 8px;">
              <%= check_box_tag "platforms[]", "twitter", false, id: "platform_twitter" %>
              Twitter
            </label>
	            <label style="display: block; margin-bottom: 8px;">
	              <%= check_box_tag "platforms[]", "bluesky", false, id: "platform_bluesky" %>
	              Bluesky
	            </label>
	          </div>
	          <div style="text-align: right;">
	            <button type="button" class="btn btn-sm" data-batch-modal-close="crosspost" style="margin-right: 10px;">取消</button>
	            <%= f.button "确认", type: "submit", class: "btn btn-sm", style: "background: #6f42c1; color: white;",
	                data: { batch_modal_submit: "batchCrosspostForm" } %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Batch Newsletter Modal -->
    <div id="batchNewsletterModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
      <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 500px; border-radius: 8px;">
        <h3>批量发送邮件</h3>
        <p>确认要向选中的文章发送邮件吗？</p>
        <%= form_with url: batch_newsletter_admin_articles_path, method: :post, id: "batchNewsletterForm" do |f| %>
          <div style="text-align: right; margin-top: 20px;">
            <button type="button" class="btn btn-sm" data-batch-modal-close="newsletter" style="margin-right: 10px;">取消</button>
            <%= f.button "确认发送", type: "submit", class: "btn btn-sm", style: "background: #fd7e14; color: white;",
                data: { batch_modal_submit: "batchNewsletterForm" } %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="table-container">
      <table class="admin-table compact-table">
        <thead>
          <tr>
            <th style="width: 40px;">
              <input type="checkbox" data-batch-selection-target="selectAll" data-action="change->batch-selection#toggleAll">
            </th>
            <th class="col-actions-compact">Actions</th>
            <th class="col-title">Title</th>
            <th class="col-status">Status</th>
            <th class="col-tags">Tags</th>
            <th class="col-comments">Comments</th>
            <th class="col-date-compact">Created</th>
            <th class="col-date-compact">Updated</th>
          </tr>
        </thead>
        <tbody>
          <% if @articles.any? %>
            <% @articles.each do |post| %>
              <tr>
                <td>
                  <input type="checkbox" value="<%= post.slug %>" 
                         data-batch-selection-target="checkbox" 
                         data-action="change->batch-selection#toggle">
                </td>
                <td class="col-actions-compact">
                  <div class="action-buttons">
                    <%= link_to article_path(post), class: "action-btn", title: "View" do %>
                      <i class="fas fa-eye"></i>
                    <% end %>
                    <%= link_to edit_admin_article_path(post), class: "action-btn", title: "Edit" do %>
                      <i class="fas fa-edit"></i>
                    <% end %>
                    <% if post.status != "trash" %>
                      <%= link_to admin_article_path(post), class: "action-btn", title: "Trash",
                            data: { turbo_method: :delete } do %>
                        <i class="fas fa-trash-alt"></i>
                      <% end %>
                    <% else %>
                      <%= link_to admin_article_path(post), class: "action-btn", title: "Delete",
                            data: { turbo_method: :delete, turbo_confirm: "Delete permanently?" } do %>
                        <i class="fas fa-trash"></i>
                      <% end %>
                    <% end %>
                  </div>
                </td>
                <td class="col-title">
                  <% display_title = post.title.presence || (post.plain_text_content.present? ? truncate(post.plain_text_content, length: 20) : post.slug) %>
                  <%= link_to display_title, edit_admin_article_path(post), class: "title-link" %>
                </td>
                <td class="col-status">
                  <span class="status-badge status-<%= post.status %>">
                    <%= post.status.humanize %>
                  </span>
                </td>
                <td class="col-tags">
                  <% if post.tags.any? %>
                    <small><%= post.tags.map(&:name).join(", ") %></small>
                  <% else %>
                    <small class="text-muted">—</small>
                  <% end %>
                </td>
                <td class="col-comments">
                  <div class="comments-info" style="display: flex; align-items: center; gap: 8px;">
                    <span class="comment-count"><%= post.comments.count %></span>
                    <% post.social_media_posts.where(platform: Crosspost::PLATFORMS).where.not(url: nil).each do |social_post| %>
                      <% icon_class = Crosspost::PLATFORM_ICONS[social_post.platform] || "fas fa-share-alt" %>
                      <%= form_with url: fetch_comments_admin_article_path(post), method: :post, 
                          class: "fetch-comments-form", 
                          style: "display: inline-block; margin: 0;",
                          data: { 
                            controller: "fetch-comments",
                            fetch_comments_platform_value: social_post.platform,
                            action: "submit->fetch-comments#submit"
                          } do |f| %>
                        <%= f.hidden_field :platform, value: social_post.platform %>
                        <%= f.button type: "submit", 
                            class: "action-btn fetch-comments-btn", 
                            title: "Fetch comments from #{social_post.platform.humanize}",
                            style: "padding: 2px 6px; font-size: 0.8em; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; color: #666;",
                            data: { fetch_comments_target: "button" } do %>
                          <i class="<%= icon_class %>" data-fetch-comments-target="icon"></i>
                        <% end %>
                      <% end %>
                    <% end %>
                  </div>
                </td>
                <td class="col-date-compact">
                  <small><%= post.created_at.strftime("%m/%d %H:%M") %></small>
                </td>
                <td class="col-date-compact">
                  <small><%= post.updated_at.strftime("%m/%d %H:%M") %></small>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="8" class="no-content-row">
                <p>No posts found.</p>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  
  <% if @articles.any? %>
    <div class="pagination-wrapper">
      <%= will_paginate @articles %>
    </div>
  <% end %>
</div>

<% content_for :javascript do %>
  <%= render 'admin/shared/batch_form_handler' %>
<% end %>
