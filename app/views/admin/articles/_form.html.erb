<%= form_with(model: [:admin, @article]) do |form| %>
  <% if @article.errors.any? %>
    <div class="form-errors">
      <strong><%= pluralize(@article.errors.count, "error") %> prohibited this article from being saved:</strong>
      <ul>
        <% @article.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="article-form-layout">
    <!-- 左侧栏：内容字段 -->
    <div class="article-form-content-column">
      <div class="form-section compact">
        <h3>Content</h3>
        
        <div class="field">
          <%= form.select :content_type, 
              options_for_select([
                ['Rich Text', 'rich_text'],
                ['HTML Code', 'html']
              ], form.object.content_type || 'rich_text'),
              {},
              { id: 'content_type_select', required: true } %>
        </div>

        <div class="field" id="rich_text_field" style="display: <%= form.object.html? ? 'none' : 'block' %>">
          <%= form.rich_text_area :content %>
        </div>

        <div class="field" id="html_content_field" style="display: <%= form.object.html? ? 'block' : 'none' %>">
          <%= form.text_area :html_content, 
              rows: 15,
              placeholder: "Enter your HTML code here...",
              class: "code-editor" %>
          <small>Raw HTML code will be rendered directly</small>
        </div>
      </div>
    </div>

    <!-- 右侧栏：其他所有字段（可滚动） -->
    <div class="article-form-sidebar-column">
      <div class="form-section compact">
        <div class="field">
          <%= form.label :title %>
          <%= form.text_field :title %>
        </div>
        <div class="field">
          <%= form.label :slug %>
          <%= form.text_field :slug %>
        </div>
        <div class="field">
          <%= form.label :created_at, "Created At" %>
          <%= form.datetime_field :created_at %>
        </div>
        <div class="field">
          <%= form.label :tag_list, "Tags" %>
          <%= form.text_field :tag_list, placeholder: "ruby, rails, web development" %>
        </div>
      </div>

      <div class="form-section compact">
        <div class="field">
          <%= form.label :description %>
          <%= form.text_area :description, rows: 1, class: "description-compact" %>
        </div>
      </div>

      <div class="form-section compact" data-controller="source-reference">
        <h3>Source Reference</h3>
        <small style="color: #666; display: block; margin-bottom: 1rem;">引用外部内容的来源信息（如推文、新闻、文章等）</small>
        
        <div class="field">
          <%= form.label :source_url, "Source URL" %>
          <div style="display: flex; gap: 0.5rem;">
            <%= form.text_field :source_url, placeholder: "https://...", style: "flex: 1;", data: { source_reference_target: "url" } %>
            <button type="button" class="btn btn-secondary" data-action="click->source-reference#archiveUrl" data-source-reference-target="archiveBtn" style="white-space: nowrap;">
              <i class="fas fa-archive"></i> Archive
            </button>
          </div>
          <small style="color: #666;">引用内容的原始链接（点击 Archive 按钮保存到 Internet Archive）</small>
        </div>

        <div class="field">
          <%= form.label :source_archive_url, "Archive URL" %>
          <%= form.text_field :source_archive_url, placeholder: "https://web.archive.org/...", style: "width: 100%;", data: { source_reference_target: "archiveUrl" }, readonly: true %>
          <small style="color: #666;">Internet Archive 存档链接（保存时自动生成，也可手动点击 Archive 按钮）</small>
        </div>

        <div class="field">
          <%= form.label :source_author, "Author / Source" %>
          <%= form.text_field :source_author, placeholder: "发言人或来源名称", data: { source_reference_target: "author" } %>
          <small style="color: #666;">引用内容的作者或来源名称</small>
        </div>

        <div class="field">
          <%= form.label :source_content, "Quote Content" %>
          <%= form.text_area :source_content, rows: 3, placeholder: "引用的主要内容...", data: { source_reference_target: "content" } %>
          <small style="color: #666;">引用内容的摘要或主要文字</small>
        </div>

        <div data-source-reference-target="status" style="display: none; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;"></div>
      </div>

      <div class="form-section compact">
        <h3>SEO Meta Tags</h3>
        
        <div class="field">
          <%= form.label :meta_title, "Meta Title" %>
          <%= form.text_field :meta_title, placeholder: "留空则使用文章标题" %>
          <small style="color: #666;">用于社交分享和搜索引擎显示的标题</small>
        </div>

        <div class="field">
          <%= form.label :meta_description, "Meta Description" %>
          <%= form.text_area :meta_description, rows: 3, placeholder: "留空则使用文章开头" %>
          <small style="color: #666;">用于社交分享和搜索引擎显示的描述（建议160字符以内）</small>
        </div>

        <div class="field">
          <%= form.label :meta_image, "Meta Image URL" %>
          <%= form.text_field :meta_image, placeholder: "留空则使用文章中的第一张图片" %>
          <small style="color: #666;">用于社交分享的图片URL（建议1200x630像素）</small>
        </div>
      </div>

      <div class="form-section compact">
        <div class="field">
          <%= form.label :status %>
          <%= form.select :status, Article.statuses.keys, 
              { prompt: 'Choose a status', selected: @article.status.presence || 'draft' }, 
              { id: 'status_select', required: true } %>
        </div>
        <div class="field" id="scheduled_at" style="display: <%= form.object.schedule? ? 'block' : 'none' %>">
          <%= form.label :scheduled_at, "Schedule For" %>
          <%= form.datetime_field :scheduled_at, value: @article.scheduled_at&.in_time_zone %>
        </div>
        <small id="scheduled_at_hint" style="display: <%= form.object.schedule? ? 'block' : 'none' %>">Current: <%= Time.current.strftime("%Y/%m/%d %I:%M %p %Z") %></small>

        <div class="field">
          <%= form.label :comment, style: "display: inline-block; font-weight: bold;" do %>
            <%= form.check_box :comment, { checked: (@article.new_record? ? true : @article.comment) }, style: "margin-right: 0.5rem;" %>
            Enable Comments
          <% end %>
        </div>
      </div>

      <div class="form-section compact">
        <div class="checkbox-group">
          <% newsletter_setting = NewsletterSetting.instance %>
          <% newsletter_enabled = newsletter_setting.enabled? %>
          <div class="field checkbox">
            <%= form.check_box :send_newsletter, disabled: !newsletter_enabled %>
            <%= form.label :send_newsletter, "Send Newsletter" %>
            <% unless newsletter_enabled %>
              <span class="info-text">(not enabled)</span>
            <% end %>
          </div>

          <% mastodon_enabled = Crosspost.find_by(platform: 'mastodon')&.enabled? %>
          <div class="field checkbox crosspost-field">
            <%= form.check_box :crosspost_mastodon, disabled: !mastodon_enabled %>
            <%= form.label :crosspost_mastodon, "Mastodon" %>
            <% unless mastodon_enabled %>
              <span class="info-text">(off)</span>
            <% end %>
            <%= form.fields_for :social_media_posts, @article.social_media_posts.find_or_initialize_by(platform: 'mastodon') do |post_form| %>
              <% if post_form.object.platform == 'mastodon' %>
                <%= post_form.label :url, "Mastodon URL", class: "sr-only" %>
                <%= post_form.text_field :url, placeholder: "URL", class: "crosspost-url-input" %>
                <%= post_form.hidden_field :platform, value: "mastodon" %>
              <% end %>
            <% end %>
          </div>

          <% twitter_enabled = Crosspost.find_by(platform: 'twitter')&.enabled? %>
          <div class="field checkbox crosspost-field">
            <%= form.check_box :crosspost_twitter, disabled: !twitter_enabled %>
            <%= form.label :crosspost_twitter, "Twitter" %>
            <% unless twitter_enabled %>
              <span class="info-text">(off)</span>
            <% end %>
            <%= form.fields_for :social_media_posts, @article.social_media_posts.find_or_initialize_by(platform: 'twitter') do |post_form| %>
              <% if post_form.object.platform == 'twitter' %>
                <%= post_form.label :url, "Twitter URL", class: "sr-only" %>
                <%= post_form.text_field :url, placeholder: "URL", class: "crosspost-url-input" %>
                <%= post_form.hidden_field :platform, value: "twitter" %>
              <% end %>
            <% end %>
          </div>

          <% bluesky_enabled = Crosspost.find_by(platform: 'bluesky')&.enabled? %>
          <div class="field checkbox crosspost-field">
            <%= form.check_box :crosspost_bluesky, disabled: !bluesky_enabled %>
            <%= form.label :crosspost_bluesky, "Bluesky" %>
            <% unless bluesky_enabled %>
              <span class="info-text">(off)</span>
            <% end %>
            <%= form.fields_for :social_media_posts, @article.social_media_posts.find_or_initialize_by(platform: 'bluesky') do |post_form| %>
              <% if post_form.object.platform == 'bluesky' %>
                <%= post_form.label :url, "Bluesky URL", class: "sr-only" %>
                <%= post_form.text_field :url, placeholder: "URL", class: "crosspost-url-input" %>
                <%= post_form.hidden_field :platform, value: "bluesky" %>
              <% end %>
            <% end %>
          </div>

          <% internet_archive_enabled = Crosspost.find_by(platform: 'internet_archive')&.enabled? %>
          <div class="field checkbox crosspost-field">
            <%= form.check_box :crosspost_internet_archive, disabled: !internet_archive_enabled %>
            <%= form.label :crosspost_internet_archive, "Internet Archive" %>
            <% unless internet_archive_enabled %>
              <span class="info-text">(off)</span>
            <% end %>
            <%= form.fields_for :social_media_posts, @article.social_media_posts.find_or_initialize_by(platform: 'internet_archive') do |post_form| %>
              <% if post_form.object.platform == 'internet_archive' %>
                <%= post_form.label :url, "Archive URL", class: "sr-only" %>
                <%= post_form.text_field :url, placeholder: "URL", class: "crosspost-url-input" %>
                <%= post_form.hidden_field :platform, value: "internet_archive" %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="form-actions">
    <%= form.submit "Save" %>
    <% if @article.persisted? %>
      <%= link_to "Delete", article_path(@article.slug), 
          class: "btn btn-danger",
          data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } %>
    <% end %>
  </div>
<% end %>

<%= javascript_tag do %>
  function initializeScheduledAt() {
    const statusSelect = document.getElementById('status_select');
    const scheduledAtContainer = document.getElementById('scheduled_at');
    const scheduledAtHint = document.getElementById('scheduled_at_hint');
    
    if (statusSelect && scheduledAtContainer) {
      statusSelect.addEventListener('change', function() {
        const isSchedule = this.value === 'schedule';
        scheduledAtContainer.style.display = isSchedule ? 'block' : 'none';
        if (scheduledAtHint) {
          scheduledAtHint.style.display = isSchedule ? 'block' : 'none';
        }
      });
    }
  }

  function initializeContentType() {
    const contentTypeSelect = document.getElementById('content_type_select');
    const richTextField = document.getElementById('rich_text_field');
    const htmlContentField = document.getElementById('html_content_field');
    const form = contentTypeSelect?.closest('form');
    
    if (contentTypeSelect && richTextField && htmlContentField && form) {
      function toggleFields() {
        const isHtml = contentTypeSelect.value === 'html';
        richTextField.style.display = isHtml ? 'none' : 'block';
        htmlContentField.style.display = isHtml ? 'block' : 'none';
        
        // 更新HTML textarea的required属性
        const htmlTextArea = htmlContentField.querySelector('textarea');
        if (htmlTextArea) {
          if (isHtml) {
            htmlTextArea.setAttribute('required', 'required');
          } else {
            htmlTextArea.removeAttribute('required');
          }
        }
        
        // 更新富文本字段的required属性（包括Action Text生成的隐藏input）
        const richTextInputs = richTextField.querySelectorAll('input[name*="[content]"], textarea[name*="[content]"]');
        richTextInputs.forEach(function(input) {
          if (isHtml) {
            input.removeAttribute('required');
          } else {
            input.setAttribute('required', 'required');
          }
        });
      }
      
      // 表单提交前，移除所有隐藏字段的required属性，避免浏览器验证错误
      form.addEventListener('submit', function(e) {
        const isHtml = contentTypeSelect.value === 'html';
        
        // 移除所有隐藏容器中的required字段
        const hiddenContainers = isHtml ? [richTextField] : [htmlContentField];
        hiddenContainers.forEach(function(container) {
          if (container && container.style.display === 'none') {
            const inputs = container.querySelectorAll('input, textarea');
            inputs.forEach(function(input) {
              input.removeAttribute('required');
            });
          }
        });
        
        // 额外检查：移除所有隐藏的content相关字段的required属性
        const allContentInputs = form.querySelectorAll('input[name*="[content]"], textarea[name*="[content]"]');
        allContentInputs.forEach(function(input) {
          const container = input.closest('#rich_text_field, #html_content_field');
          if (container && container.style.display === 'none') {
            input.removeAttribute('required');
          }
        });
      });
      
      contentTypeSelect.addEventListener('change', toggleFields);
      toggleFields(); // 初始化时执行一次
    }
  }
  
  document.addEventListener("DOMContentLoaded", function() {
    initializeScheduledAt();
    initializeContentType();
  });
  document.addEventListener("turbo:load", function() {
    initializeScheduledAt();
    initializeContentType();
  });
<% end %>
