<h3>订阅者管理</h3>

<div style="margin-bottom: 30px; padding: 20px; background: #f5f5f5; border-radius: 4px;">
  <h4 style="margin-top: 0;">批量添加订阅者</h4>
  <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
    每行输入一个邮箱地址，可以在邮箱后加逗号，再输入tag名称来订阅特定内容。格式示例：<br>
    <code>a@example.com,tag1</code><br>
    <code>b@example.com</code><br>
    <code>c@example.com,tag2,tag3,tag4</code>
  </p>
  <%= form_with url: batch_create_admin_subscribers_path, method: :post, local: true do |form| %>
    <div style="margin-bottom: 10px;">
      <%= form.text_area :emails_text, 
          rows: 8, 
          placeholder: "a@example.com,tag1\nb@example.com\nc@example.com,tag2,tag3", 
          style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 14px;" %>
    </div>
    <%= form.submit "批量添加", class: "btn btn-primary" %>
  <% end %>
</div>

<div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px;">
  <h4 style="margin-top: 0;">筛选</h4>
  <%= form_with url: admin_subscribers_path, method: :get, local: true do |form| %>
    <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: end;">
      <div>
        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px;">状态</label>
        <%= select_tag :status,
              options_for_select(
                [
                  [ "全部", "all" ],
                  [ "已确认", "active" ],
                  [ "待确认", "unconfirmed" ],
                  [ "已取消", "unsubscribed" ]
                ],
                @status
              ),
              style: "padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;" %>
      </div>

      <div>
        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px;">订阅内容（可多选 Tag）</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <label style="display: flex; gap: 6px; align-items: center; margin: 0;">
            <%= check_box_tag :include_all, "1", @include_all %>
            <span>所有内容</span>
          </label>
          <%= select_tag "tag_ids[]",
                options_from_collection_for_select(@tags, :id, :name, @tag_ids),
                multiple: true,
                size: 4,
                style: "min-width: 200px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;" %>
        </div>
      </div>

      <div style="display: flex; gap: 10px;">
        <%= form.submit "筛选", class: "btn btn-primary btn-sm" %>
        <%= link_to "重置", admin_subscribers_path, class: "btn btn-secondary btn-sm" %>
      </div>
    </div>
  <% end %>
</div>

<div data-controller="batch-selection">
  <div data-batch-selection-target="actions" style="display: none; padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px; gap: 10px;">
    <span style="margin-right: 10px;"><strong><span data-batch-selection-target="count">0</span></strong> 个已选择</span>

    <%= form_with url: batch_confirm_admin_subscribers_path, method: :post, style: "display: inline;" do |f| %>
      <%= f.button "改为已确认", type: "submit", class: "btn btn-sm", style: "background: #28a745; color: white;",
          data: { batch_action: "confirm" } %>
    <% end %>

    <%= form_with url: batch_destroy_admin_subscribers_path, method: :post, style: "display: inline;" do |f| %>
      <%= f.button "删除", type: "submit", class: "btn btn-sm", style: "background: #dc3545; color: white;",
          data: { batch_action: "delete" } %>
    <% end %>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th style="width: 40px;">
            <input type="checkbox" data-batch-selection-target="selectAll" data-action="change->batch-selection#toggleAll">
          </th>
          <th>Email</th>
          <th>状态</th>
          <th>订阅内容</th>
          <th>订阅时间</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <% @subscribers.each do |subscriber| %>
          <tr>
            <td>
              <input type="checkbox" value="<%= subscriber.id %>"
                     data-batch-selection-target="checkbox"
                     data-action="change->batch-selection#toggle">
            </td>
            <td><%= subscriber.email %></td>
            <td>
              <% if subscriber.active? %>
                <span class="badge badge-success">已确认</span>
              <% elsif subscriber.confirmed? %>
                <span class="badge badge-warning">已取消</span>
              <% else %>
                <span class="badge badge-secondary">待确认</span>
              <% end %>
            </td>
            <td>
              <% if subscriber.tags.any? %>
                <span style="color: #666;">
                  <%= subscriber.tags.pluck(:name).join(", ") %>
                </span>
              <% else %>
                <span style="color: #28a745; font-weight: 500;">所有内容</span>
              <% end %>
            </td>
            <td><%= subscriber.created_at.strftime("%Y-%m-%d %H:%M") %></td>
            <td>
              <%= link_to "删除", admin_subscriber_path(subscriber),
                  data: { turbo_method: :delete, turbo_confirm: "确定要删除这个订阅者吗？" },
                  class: "btn btn-danger btn-sm" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div style="margin-top: 20px;">
  <%= will_paginate @subscribers %>
</div>

<p style="margin-top: 20px;">
  <%= link_to "返回 Newsletter 设置", admin_newsletter_path, class: "btn btn-secondary" %>
</p>

<% content_for :javascript do %>
  <%= render "admin/shared/batch_form_handler" %>
<% end %>
