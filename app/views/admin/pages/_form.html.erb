<%= form_with(model: [:admin, page]) do |form| %>
  <% if page.errors.any? %>
    <div class="form-errors">
      <strong><%= pluralize(page.errors.count, "error") %> prohibited this page from being saved:</strong>
      <ul>
        <% page.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="article-form-layout">
    <!-- 左侧栏：内容字段 -->
    <div class="article-form-content-column">
      <div class="form-section compact">
        <h3>Content</h3>
        
        <div class="field">
          <%= form.select :content_type, 
              options_for_select([
                ['Rich Text', 'rich_text'],
                ['HTML Code', 'html']
              ], form.object.content_type || 'rich_text'),
              {},
              { id: 'content_type_select', required: true } %>
        </div>

        <div class="field" id="rich_text_field" style="display: <%= form.object.html? ? 'none' : 'block' %>">
          <%= form.text_area :content,
              class: "tinymce-editor",
              value: form.object.content.to_s %>
        </div>

        <div class="field" id="html_content_field" style="display: <%= form.object.html? ? 'block' : 'none' %>">
          <%= form.text_area :html_content, 
              rows: 15,
              placeholder: "Enter your HTML code here...",
              class: "code-editor" %>
          <small>Raw HTML code will be rendered directly</small>
        </div>
      </div>
    </div>

    <!-- 右侧栏：其他所有字段（可滚动） -->
    <div class="article-form-sidebar-column">
      <div class="form-section compact">
        <h3>Basic Information</h3>

        <div class="field">
          <%= form.label :title %>
          <%= form.text_field :title, required: true %>
        </div>

        <div class="field">
          <%= form.label :slug %>
          <%= form.text_field :slug, required: true %>
        </div>

        <div class="field">
          <%= form.label :page_order, "Page Order" %>
          <%= form.number_field :page_order, required: true %>
        </div>

        <div class="field">
          <%= form.label :redirect_url, "Redirect To (Optional)" %>
          <%= form.url_field :redirect_url, placeholder: "https://example.com" %>
        </div>
        
        <small>Leave redirect URL empty to use page content</small>
      </div>

      <div class="form-section compact">
        <h3>Publishing</h3>

        <div class="field">
          <%= form.label :status %>
          <%= form.select :status, Page.statuses.keys, 
              { prompt: 'Choose a status' }, 
              { id: 'status_select', required: true } %>
        </div>

        <div class="field" id="scheduled_at" style="display: <%= form.object.schedule? ? 'block' : 'none' %>">
          <%= form.label :scheduled_at, "Schedule For" %>
          <%= form.datetime_field :scheduled_at %>
          <small>Current: <%= Time.current.strftime("%Y/%m/%d %I:%M %p %Z") %></small>
        </div>

        <div class="field">
          <%= form.label :comment, style: "display: inline-block; font-weight: bold;" do %>
            <%= form.check_box :comment, { checked: (page.new_record? ? true : page.comment) }, style: "margin-right: 0.5rem;" %>
            Enable Comments
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="form-actions">
    <%= form.submit "Save" %>
    <% if page.persisted? %>
      <%= link_to "Delete", admin_page_path(page), 
          class: "btn btn-danger",
          data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } %>
    <% end %>
  </div>
<% end %>

<%= javascript_tag do %>
  function initializeScheduledAt() {
    const statusSelect = document.getElementById('status_select');
    const scheduledAtContainer = document.getElementById('scheduled_at');
    
    if (statusSelect && scheduledAtContainer) {
      statusSelect.addEventListener('change', function() {
        scheduledAtContainer.style.display = this.value === 'schedule' ? 'block' : 'none';
      });
    }
  }

  function initializeContentType() {
    const contentTypeSelect = document.getElementById('content_type_select');
    const richTextField = document.getElementById('rich_text_field');
    const htmlContentField = document.getElementById('html_content_field');
    const form = contentTypeSelect?.closest('form');
    
    if (contentTypeSelect && richTextField && htmlContentField && form) {
      function toggleFields() {
        const isHtml = contentTypeSelect.value === 'html';
        richTextField.style.display = isHtml ? 'none' : 'block';
        htmlContentField.style.display = isHtml ? 'block' : 'none';
        
        // 更新HTML textarea的required属性
        const htmlTextArea = htmlContentField.querySelector('textarea');
        if (htmlTextArea) {
          if (isHtml) {
            htmlTextArea.setAttribute('required', 'required');
          } else {
            htmlTextArea.removeAttribute('required');
          }
        }
        
        // 更新富文本字段的required属性（包括Action Text生成的隐藏input）
        // 注意：TinyMCE textarea 不应该有 required 属性，因为它会被隐藏
        const richTextInputs = richTextField.querySelectorAll('input[name*="[content]"]');
        richTextInputs.forEach(function(input) {
          if (isHtml) {
            input.removeAttribute('required');
          } else {
            input.setAttribute('required', 'required');
          }
        });

        // 关键修复：TinyMCE textarea 永远不应该有 required 属性
        // 因为它被 TinyMCE 隐藏（display: none），浏览器无法 focus 隐藏的 required 元素
        const tinymceTextarea = richTextField.querySelector('textarea.tinymce-editor');
        if (tinymceTextarea) {
          tinymceTextarea.removeAttribute('required');
        }
      }
      
      // 表单提交前处理
      form.addEventListener('submit', function(e) {
        const isHtml = contentTypeSelect.value === 'html';

        // 同步 TinyMCE 内容到 textarea（如果不是 HTML 模式）
        if (!isHtml && typeof tinymce !== 'undefined') {
          tinymce.triggerSave();
        }

        // 关键修复：移除所有 textarea 的 required 属性
        // TinyMCE 隐藏的 textarea 会导致浏览器验证错误 "An invalid form control is not focusable"
        const allTextareas = form.querySelectorAll('textarea[name*="[content]"]');
        allTextareas.forEach(function(textarea) {
          textarea.removeAttribute('required');
        });

        // 自定义验证：检查内容是否为空
        if (!isHtml) {
          // Rich Text 模式：检查 TinyMCE 内容
          let content = '';
          if (typeof tinymce !== 'undefined') {
            const editor = tinymce.get('page_content');
            if (editor) {
              content = editor.getContent().trim();
            }
          }
          // 如果 TinyMCE 未加载，检查 textarea 的值
          if (!content) {
            const textarea = form.querySelector('textarea[name="page[content]"]');
            if (textarea && textarea.value.trim()) {
              content = textarea.value.trim();
            }
          }
          if (!content) {
            e.preventDefault();
            alert('Content cannot be blank');
            return false;
          }
        } else {
          // HTML 模式：检查 html_content
          const htmlTextarea = form.querySelector('textarea[name="page[html_content]"]');
          if (!htmlTextarea || !htmlTextarea.value.trim()) {
            e.preventDefault();
            alert('HTML content cannot be blank');
            return false;
          }
        }
      });
      
      contentTypeSelect.addEventListener('change', toggleFields);
      toggleFields(); // 初始化时执行一次
    }
  }
  
  document.addEventListener("DOMContentLoaded", function() {
    initializeScheduledAt();
    initializeContentType();
  });
  document.addEventListener("turbo:load", function() {
    initializeScheduledAt();
    initializeContentType();
  });
<% end %>