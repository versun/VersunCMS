<%= form_with(model: [:admin, page]) do |form| %>
  <% if page.errors.any? %>
    <div class="form-errors">
      <strong><%= pluralize(page.errors.count, "error") %> prohibited this page from being saved:</strong>
      <ul>
        <% page.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="article-form-layout">
    <!-- 左侧栏：内容字段 -->
    <div class="article-form-content-column">
      <div class="form-section compact">
        <h3>Content</h3>
        
        <div class="field">
          <%= form.select :content_type, 
              options_for_select([
                ['Rich Text', 'rich_text'],
                ['HTML Code', 'html']
              ], form.object.content_type || 'rich_text'),
              {},
              { id: 'content_type_select', required: true } %>
        </div>

        <div class="field" id="rich_text_field" style="display: <%= form.object.html? ? 'none' : 'block' %>">
          <%= form.rich_text_area :content %>
        </div>

        <div class="field" id="html_content_field" style="display: <%= form.object.html? ? 'block' : 'none' %>">
          <%= form.text_area :html_content, 
              rows: 15,
              placeholder: "Enter your HTML code here...",
              class: "code-editor" %>
          <small>Raw HTML code will be rendered directly</small>
        </div>
      </div>
    </div>

    <!-- 右侧栏：其他所有字段（可滚动） -->
    <div class="article-form-sidebar-column">
      <div class="form-section compact">
        <h3>Basic Information</h3>

        <div class="field">
          <%= form.label :title %>
          <%= form.text_field :title, required: true %>
        </div>

        <div class="field">
          <%= form.label :slug %>
          <%= form.text_field :slug, required: true %>
        </div>

        <div class="field">
          <%= form.label :page_order, "Page Order" %>
          <%= form.number_field :page_order, required: true %>
        </div>

        <div class="field">
          <%= form.label :redirect_url, "Redirect To (Optional)" %>
          <%= form.url_field :redirect_url, placeholder: "https://example.com" %>
        </div>
        
        <small>Leave redirect URL empty to use page content</small>
      </div>

      <div class="form-section compact">
        <h3>Publishing</h3>

        <div class="field">
          <%= form.label :status %>
          <%= form.select :status, Page.statuses.keys, 
              { prompt: 'Choose a status' }, 
              { id: 'status_select', required: true } %>
        </div>

        <div class="field" id="scheduled_at" style="display: <%= form.object.schedule? ? 'block' : 'none' %>">
          <%= form.label :scheduled_at, "Schedule For" %>
          <%= form.datetime_field :scheduled_at %>
          <small>Current: <%= Time.current.strftime("%Y/%m/%d %I:%M %p %Z") %></small>
        </div>

        <div class="field">
          <%= form.label :comment, style: "display: inline-block; font-weight: bold;" do %>
            <%= form.check_box :comment, { checked: (page.new_record? ? true : page.comment) }, style: "margin-right: 0.5rem;" %>
            Enable Comments
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="form-actions">
    <%= form.submit "Save" %>
    <% if page.persisted? %>
      <%= link_to "Delete", admin_page_path(page), 
          class: "btn btn-danger",
          data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } %>
    <% end %>
  </div>
<% end %>

<%= javascript_tag do %>
  function initializeScheduledAt() {
    const statusSelect = document.getElementById('status_select');
    const scheduledAtContainer = document.getElementById('scheduled_at');
    
    if (statusSelect && scheduledAtContainer) {
      statusSelect.addEventListener('change', function() {
        scheduledAtContainer.style.display = this.value === 'schedule' ? 'block' : 'none';
      });
    }
  }

  function initializeContentType() {
    const contentTypeSelect = document.getElementById('content_type_select');
    const richTextField = document.getElementById('rich_text_field');
    const htmlContentField = document.getElementById('html_content_field');
    const form = contentTypeSelect?.closest('form');
    
    if (contentTypeSelect && richTextField && htmlContentField && form) {
      function toggleFields() {
        const isHtml = contentTypeSelect.value === 'html';
        richTextField.style.display = isHtml ? 'none' : 'block';
        htmlContentField.style.display = isHtml ? 'block' : 'none';
        
        // 更新HTML textarea的required属性
        const htmlTextArea = htmlContentField.querySelector('textarea');
        if (htmlTextArea) {
          if (isHtml) {
            htmlTextArea.setAttribute('required', 'required');
          } else {
            htmlTextArea.removeAttribute('required');
          }
        }
        
        // 更新富文本字段的required属性（包括Action Text生成的隐藏input）
        const richTextInputs = richTextField.querySelectorAll('input[name*="[content]"], textarea[name*="[content]"]');
        richTextInputs.forEach(function(input) {
          if (isHtml) {
            input.removeAttribute('required');
          } else {
            input.setAttribute('required', 'required');
          }
        });
      }
      
      // 表单提交前，移除所有隐藏字段的required属性，避免浏览器验证错误
      form.addEventListener('submit', function(e) {
        const isHtml = contentTypeSelect.value === 'html';
        
        // 移除所有隐藏容器中的required字段
        const hiddenContainers = isHtml ? [richTextField] : [htmlContentField];
        hiddenContainers.forEach(function(container) {
          if (container && container.style.display === 'none') {
            const inputs = container.querySelectorAll('input, textarea');
            inputs.forEach(function(input) {
              input.removeAttribute('required');
            });
          }
        });
        
        // 额外检查：移除所有隐藏的content相关字段的required属性
        const allContentInputs = form.querySelectorAll('input[name*="[content]"], textarea[name*="[content]"]');
        allContentInputs.forEach(function(input) {
          const container = input.closest('#rich_text_field, #html_content_field');
          if (container && container.style.display === 'none') {
            input.removeAttribute('required');
          }
        });
      });
      
      contentTypeSelect.addEventListener('change', toggleFields);
      toggleFields(); // 初始化时执行一次
    }
  }
  
  document.addEventListener("DOMContentLoaded", function() {
    initializeScheduledAt();
    initializeContentType();
  });
  document.addEventListener("turbo:load", function() {
    initializeScheduledAt();
    initializeContentType();
  });
<% end %>