<% content_for :title, "Generate Settings|Admin" %>

<div class="admin-generates">
  <div class="page-header">
    <h1>Generate Settings</h1>
    <div class="header-actions">
      <%= button_to "立即生成静态文件", admin_generate_static_path, method: :post, class: "btn btn-success", data: { turbo_confirm: "确定要生成静态文件吗？这可能需要一些时间。" } %>
    </div>
  </div>

  <%= form_with(model: @setting, url: admin_generate_path) do |form| %>
    <% if @setting.errors.any? %>
      <div class="form-errors">
        <strong><%= pluralize(@setting.errors.count, "error") %> prohibited this setting from being saved:</strong>
        <ul>
          <% @setting.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-section">
      <div class="field">
        <%= form.label :deploy_provider, "Deploy Destination" %>
        <%
          effective_provider = @setting.deploy_provider_effective
          provider_options = [["Local", "local"]]
          GitIntegration::PROVIDERS.each do |provider|
            integration = @git_integrations_by_provider[provider]
            label = integration&.display_name || GitIntegration::PROVIDER_NAMES.fetch(provider)

            if integration&.enabled? || effective_provider == provider
              provider_options << [integration&.enabled? ? label : "#{label} (未配置)", provider]
            else
              provider_options << ["#{label} (未配置)", provider, { disabled: true }]
            end
          end
        %>
        <%= form.select :deploy_provider,
                     options_for_select(provider_options, effective_provider || "local"),
                     {},
                     { id: "setting_deploy_provider" } %>
        <small>选择静态文件的保存目标：本地目录或 Git 仓库。<%= link_to "配置 Git 集成", admin_git_integrations_path %></small>
      </div>
    </div>

    <div class="form-section" id="local-settings" style="<%= 'display: none;' unless effective_provider.blank? || effective_provider == 'local' %>">
      <div class="field">
        <%= form.label :local_generation_path, "Generation Path" %>
        <%= form.text_field :local_generation_path, placeholder: Rails.root.join("public").to_s %>
      </div>
    </div>

    <div class="form-section" id="git-settings" style="<%= 'display: none;' if effective_provider.blank? || effective_provider == 'local' %>">
      <div class="field">
        <%= form.label :deploy_repo_url, "Repository URL" %>
        <%= form.text_field :deploy_repo_url, placeholder: "https://github.com/username/repo.git 或 user/repo" %>
        <small>仓库 URL，支持 HTTPS 或简写格式（如 user/repo）</small>
      </div>

      <div class="field">
        <%= form.label :deploy_branch, "Branch Name" %>
        <%= form.text_field :deploy_branch, placeholder: "main" %>
      </div>
    </div>

    <div class="form-section">
      <div class="field">
        <%= form.label :static_generation_delay, "Generation Delay" %>
        <%= form.select :static_generation_delay,
                     options_for_select([
                       ["立即 (Immediately)", "0s"],
                       ["30秒后 (30 seconds)", "30s"],
                       ["2分钟后 (2 minutes)", "2m"],
                       ["5分钟后 (5 minutes)", "5m"],
                       ["15分钟后 (15 minutes)", "15m"]
                     ], @setting.static_generation_delay || "2m"),
                     {},
                     { id: "setting_static_generation_delay" } %>
        <small>延迟时间可以避免频繁更新时重复生成静态文件</small>
      </div>
    </div>

    <div class="form-section">
      <small>Select the content types that should trigger automatic static file generation</small>

      <div class="field">
        <div class="checkbox-group">
          <%
            triggers = @setting.auto_regenerate_triggers || []
            trigger_options = [
              ['article_update', 'Article Update'],
              ['comment_update', 'Comment Update'],
              ['crosspost_update', 'Crosspost Update'],
              ['page_update', 'Page Update'],
              ['static_file_upload', 'New Static Files Uploaded'],
              ['tag_update', 'Tag Update']
            ]
          %>
          <% trigger_options.each do |value, label| %>
            <div class="field checkbox">
              <%= check_box_tag "setting[auto_regenerate_triggers][]", value, triggers.include?(value), id: "setting_auto_regenerate_triggers_#{value}" %>
              <%= label_tag "setting_auto_regenerate_triggers_#{value}", label %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <%= form.submit 'Save Settings', class: "btn btn-primary" %>
      <%= link_to 'Cancel', admin_root_path, class: "btn btn-secondary" %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('turbo:load', function() {
    const providerSelect = document.querySelector('#setting_deploy_provider');
    const localSettings = document.getElementById('local-settings');
    const gitSettings = document.getElementById('git-settings');

    if (providerSelect) {
      function updateSettingsVisibility() {
        if (providerSelect.value === 'local' || providerSelect.value === '') {
          if (localSettings) localSettings.style.display = 'block';
          if (gitSettings) gitSettings.style.display = 'none';
        } else {
          if (localSettings) localSettings.style.display = 'none';
          if (gitSettings) gitSettings.style.display = 'block';
        }
      }

      updateSettingsVisibility();
      providerSelect.addEventListener('change', updateSettingsVisibility);
    }
  });
</script>
