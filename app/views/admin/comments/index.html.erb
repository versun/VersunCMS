<% content_for :title, "Comments|Admin" %>

<% site_author = site_settings[:author].to_s.strip %>
<% site_url = site_settings[:url].to_s.strip %>

<div class="admin-comments">
  <div class="admin-toolbar">
    <div class="status-tabs">
      <%= link_to "All", admin_comments_path, class: "status-tab #{params[:status].blank? ? 'active' : ''}" %>
      <%= link_to "Pending", admin_comments_path(status: 'pending'), class: "status-tab #{params[:status] == 'pending' ? 'active' : ''}" %>
      <%= link_to "Approved", admin_comments_path(status: 'approved'), class: "status-tab #{params[:status] == 'approved' ? 'active' : ''}" %>
      <%= link_to "Rejected", admin_comments_path(status: 'rejected'), class: "status-tab #{params[:status] == 'rejected' ? 'active' : ''}" %>
    </div>
  </div>

  <div data-controller="batch-selection">
    <!-- Batch Actions Bar -->
    <div data-batch-selection-target="actions" style="display: none; padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px; gap: 10px;">
      <span style="margin-right: 10px;"><strong><span data-batch-selection-target="count">0</span></strong> selected</span>
      
      <%= form_with url: batch_approve_admin_comments_path, method: :post, style: "display: inline;" do |f| %>
        <%= f.button "Approve", type: "submit", class: "btn btn-sm", style: "background: #28a745; color: white;",
            onclick: "return submitBatchForm(this, 'approve')" %>
      <% end %>

      <%= form_with url: batch_reject_admin_comments_path, method: :post, style: "display: inline;" do |f| %>
        <%= f.button "Reject", type: "submit", class: "btn btn-sm", style: "background: #ffc107; color: black;",
            onclick: "return submitBatchForm(this, 'reject')" %>
      <% end %>

      <%= form_with url: batch_destroy_admin_comments_path, method: :post, style: "display: inline;" do |f| %>
        <%= f.button "Delete", type: "submit", class: "btn btn-sm", style: "background: #dc3545; color: white;",
            onclick: "return submitBatchForm(this, 'delete')" %>
      <% end %>
    </div>

    <div class="table-container">
      <table class="admin-table compact-table">
        <thead>
          <tr>
            <th style="width: 40px;">
              <input type="checkbox" data-batch-selection-target="selectAll" data-action="change->batch-selection#toggleAll">
            </th>
            <th class="col-actions-compact">Actions</th>
            <th class="col-compact">Status</th>
            <th class="col-content">Content</th>
            <th class="col-title">Article/Page</th>
            <th class="col-title">Author</th>
            <th class="col-date-compact">Date</th>
          </tr>
        </thead>
        <tbody>
          <% if @comments.any? %>
            <% @comments.each do |comment| %>
              <tr>
                <td>
                  <input type="checkbox" value="<%= comment.id %>" 
                         data-batch-selection-target="checkbox" 
                         data-action="change->batch-selection#toggle">
                </td>
                <td class="col-actions-compact">
                  <div class="action-buttons">
                    <% if comment.platform.nil? %>
                      <% unless comment.approved? %>
                        <%= link_to approve_admin_comment_path(comment), data: { turbo_method: :patch }, class: "action-btn", title: "Approve" do %>
                          <i class="fas fa-check"></i>
                        <% end %>
                      <% end %>
                      <% unless comment.rejected? %>
                        <%= link_to reject_admin_comment_path(comment), data: { turbo_method: :patch }, class: "action-btn", title: "Reject" do %>
                          <i class="fas fa-ban"></i>
                        <% end %>
                      <% end %>
                      <%= link_to edit_admin_comment_path(comment), class: "action-btn", title: "Edit" do %>
                        <i class="fas fa-edit"></i>
                      <% end %>
                    <% end %>
                    <%= link_to admin_comment_path(comment), class: "action-btn", title: "Delete",
                          data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } do %>
                      <i class="fas fa-trash-alt"></i>
                    <% end %>
                  </div>
                </td>
                <td class="col-compact">
                  <% if comment.approved? %>
                    <span style="color: green;">✓</span>
                  <% elsif comment.rejected? %>
                    <span style="color: red;">✕</span>
                  <% else %>
                    <span style="color: orange;">⏳</span>
                  <% end %>
                </td>
                <td class="col-content">
                  <small><%= comment.content.truncate(100) %></small>
                  <% if comment.platform.nil? %>
                    <details style="margin-top: 0.5rem;">
                      <summary style="cursor: pointer; font-size: 0.85rem; color: #333;">Reply</summary>
                      <div style="margin-top: 0.5rem;">
                        <%= form_with url: reply_admin_comment_path(comment), method: :post, scope: :comment, local: true do |f| %>
                          <%= f.text_area :content, required: true, rows: 3, placeholder: "Reply...", style: "width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" %>
                          <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <%= f.submit "Reply", style: "padding: 0.35rem 0.75rem; background-color: #333; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;" %>
                            <% if site_author.present? %>
                              <small style="color: #666;">as <%= site_author %><% if site_url.present? %> · <%= site_url %><% end %></small>
                            <% end %>
                          </div>
                        <% end %>
                      </div>
                    </details>
                  <% end %>
                </td>
                <td class="col-title">
                  <% display_commentable = comment.display_commentable %>
                  <% display_title = display_commentable&.title.presence || display_commentable&.try(:slug) %>
                  <% if display_commentable %>
                    <% if display_commentable.is_a?(Article) %>
                      <%= link_to display_title.to_s.truncate(50), article_path(display_commentable), class: "title-link", target: "_blank" %>
                    <% elsif display_commentable.is_a?(Page) %>
                      <%= link_to display_title.to_s.truncate(50), page_path(display_commentable), class: "title-link", target: "_blank" %>
                    <% else %>
                      <%= display_title.to_s.truncate(50) %>
                    <% end %>
                  <% else %>
                    <small class="text-muted">—</small>
                  <% end %>
                </td>
                <td class="col-title">
                  <strong><%= comment.author_name %></strong>
                  <% if comment.author_url.present? %>
                    <br><small><%= link_to comment.author_url, comment.author_url, target: "_blank", style: "color: #666;" %></small>
                  <% end %>
                  <% if comment.platform.present? %>
                    <br><small style="color: #999;">via <%= comment.platform.titleize %></small>
                  <% end %>
                </td>
                
                <td class="col-date-compact">
                  <small><%= comment.published_at&.strftime("%m/%d %H:%M") || comment.created_at.strftime("%m/%d %H:%M") %></small>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="7" class="no-content-row">
                <p>No comments found.</p>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  
  <% if @comments.any? %>
    <div class="pagination-wrapper">
      <%= will_paginate @comments %>
    </div>
  <% end %>
</div>

<% content_for :javascript do %>
  <%= render 'admin/shared/batch_form_handler' %>
<% end %>
