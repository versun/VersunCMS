<div class="admin-container">
  <h1>Crosspost Settings</h1>

  <div class="form-section compact">
    <h3>Mastodon</h3>
    <small>Get credentials: Open Mastodon → Preferences → Development → New application | Scope: profile,write:statuses</small>
    
    <%= form_with(model: @mastodon, url: admin_crosspost_path(@mastodon.platform), method: :patch) do |f| %>
      <%= f.hidden_field :platform, value: 'mastodon' %>

      <div class="field checkbox">
        <%= f.check_box :enabled %>
        <%= f.label :enabled, "Enable Mastodon CrossPost" %>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <%= f.label :server_url, "Mastodon Server URL" %>
          <%= f.text_field :server_url, placeholder: "https://mastodon.social" %>
        </div>

        <div class="field">
          <%= f.label :client_key, "Client Key" %>
          <%= f.text_field :client_key %>
        </div>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <%= f.label :client_secret, "Client Secret" %>
          <%= f.text_field :client_secret %>
        </div>

        <div class="field">
          <%= f.label :access_token, "Access Token" %>
          <%= f.text_field :access_token %>
        </div>
      </div>

      <div class="field checkbox">
        <%= f.check_box :auto_fetch_comments %>
        <%= f.label :auto_fetch_comments, "Auto-fetch Comments" %>
      </div>
      <small>Automatically fetch and display comments from Mastodon every day</small>

      <div class="form-actions">
        <%= f.submit "Save", class: 'btn btn-primary' %>
        <%= button_tag "Verify", type: 'button', class: 'btn btn-secondary verify-btn', data: { platform: 'mastodon' } %>
      </div>
    <% end %>
  </div>

  <div class="form-section compact">
    <h3>X (Twitter)</h3>
    <small>First, obtain X credentials from <%= link_to "https://developer.x.com", "https://developer.x.com", target: "_blank" %></small>
    
    <%= form_with(model: @twitter, url: admin_crosspost_path(@twitter.platform), method: :patch) do |f| %>
      <%= f.hidden_field :platform, value: 'twitter' %>

      <div class="field checkbox">
        <%= f.check_box :enabled %>
        <%= f.label :enabled, "Enable X CrossPost" %>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <%= f.label :access_token, "Access Token" %>
          <%= f.text_field :access_token %>
        </div>

        <div class="field">
          <%= f.label :access_token_secret, "Access Token Secret" %>
          <%= f.text_field :access_token_secret %>
        </div>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <%= f.label :api_key, "API Key" %>
          <%= f.text_field :api_key %>
        </div>

        <div class="field">
          <%= f.label :api_key_secret, "API Key Secret" %>
          <%= f.text_field :api_key_secret %>
        </div>
      </div>

      <div class="form-actions">
        <%= f.submit "Save", class: 'btn btn-primary' %>
        <%= button_tag "Verify", type: 'button', class: 'btn btn-secondary verify-btn', data: { platform: 'twitter' } %>
      </div>
    <% end %>
  </div>

  <div class="form-section compact">
    <h3>Bluesky</h3>
    <small>Get credentials: Log in to your Bluesky account and generate an App Password in settings.</small>
    
    <%= form_with(model: @bluesky, url: admin_crosspost_path(@bluesky.platform), method: :patch) do |f| %>
      <%= f.hidden_field :platform, value: 'bluesky' %>

      <div class="field checkbox">
        <%= f.check_box :enabled %>
        <%= f.label :enabled, "Enable Bluesky CrossPost" %>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <%= f.label :username, "Username" %>
          <%= f.text_field :username, placeholder: "your.handle" %>
        </div>

        <div class="field">
          <%= f.label :app_password, "App Password" %>
          <%= f.text_field :app_password %>
        </div>
      </div>

      <div class="field">
        <%= f.label :server_url, "Server URL" %>
        <%= f.text_field :server_url, placeholder: "https://bsky.social/xrpc" %>
      </div>

      <div class="field checkbox">
        <%= f.check_box :auto_fetch_comments %>
        <%= f.label :auto_fetch_comments, "Auto-fetch Comments" %>
      </div>
      <small>Automatically fetch and display comments from Bluesky every day</small>

      <div class="form-actions">
        <%= f.submit "Save", class: 'btn btn-primary' %>
        <%= button_tag "Verify", type: 'button', class: 'btn btn-secondary verify-btn', data: { platform: 'bluesky' } %>
      </div>
    <% end %>
  </div>

  <div class="form-section">
    <h3>Activity History</h3>
    <%= render 'admin/shared/activitylog', activity_logs: @activity_logs %>
  </div>
</div>

<% content_for :javascript do %>
<script>
document.addEventListener('turbo:load', function() {
  const verifyButtons = document.querySelectorAll('.verify-btn');

  verifyButtons.forEach(button => {
    button.addEventListener('click', function() {
      const platform = this.dataset.platform;
      const form = this.closest('form');
      const formData = new FormData(form);
      const button = this;

      const jsonData = {};
      formData.forEach((value, key) => {
        if (key.startsWith('crosspost')) {
          const cleanKey = key.replace('crosspost[', '').replace(']', '');
          jsonData[cleanKey] = value;
        }
      });

      button.disabled = true;
      const originalText = button.innerHTML;
      button.innerHTML = 'Verifying...';

      fetch(`/admin/crossposts/${platform}/verify`, {
        method: 'POST',
        body: JSON.stringify({ crosspost: jsonData }),
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        alert(data.message);
      })
      .catch(error => {
        alert('An error occurred during verification.');
        console.error('Error:', error);
      })
      .finally(() => {
        button.disabled = false;
        button.innerHTML = originalText;
      });
    });
  });
});
</script>
<% end %>
