<div class="admin-container">
  <h1>Crosspost Settings</h1>

  <div class="form-section compact">
    <h3>Mastodon</h3>
    <small>Get credentials: Open Mastodon → Preferences → Development → New application | Scope: profile,write:statuses</small>
    
    <%= form_with(model: @mastodon, url: admin_crosspost_path(@mastodon.platform), method: :patch) do |f| %>
      <%= f.hidden_field :platform, value: 'mastodon' %>

      <div class="field checkbox">
        <%= f.check_box :enabled, id: 'crosspost_enabled_mastodon' %>
        <%= f.label :enabled, "Enable Mastodon CrossPost", for: 'crosspost_enabled_mastodon' %>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <%= f.label :server_url, "Mastodon Server URL" %>
          <%= f.text_field :server_url, placeholder: "https://mastodon.social" %>
        </div>

        <div class="field">
          <%= f.label :client_key, "Client Key" %>
          <%= f.text_field :client_key %>
        </div>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <%= f.label :client_secret, "Client Secret" %>
          <%= f.text_field :client_secret %>
        </div>

        <div class="field">
          <%= f.label :access_token, "Access Token" %>
          <%= f.text_field :access_token %>
        </div>
      </div>

      <div class="field checkbox">
        <%= f.check_box :auto_fetch_comments %>
        <%= f.label :auto_fetch_comments, "Auto-fetch Comments" %>
      </div>
      <small>Automatically fetch and display comments from Mastodon every day</small>

      <div class="form-actions">
        <%= f.submit "Save", class: 'btn btn-primary' %>
        <div id="verify-button-mastodon">
          <%= button_tag "Verify", type: 'submit', class: 'btn btn-secondary', form: "verify-form-mastodon", data: { turbo_frame: "_top" } %>
        </div>
      </div>
    <% end %>

    <%= form_with(url: verify_admin_crosspost_path('mastodon'), method: :post, data: { turbo: true }, id: "verify-form-mastodon") do |vf| %>
      <%= hidden_field_tag 'crosspost[platform]', 'mastodon' %>
      <%= hidden_field_tag 'crosspost[server_url]', @mastodon.server_url, id: 'verify_server_url_mastodon' %>
      <%= hidden_field_tag 'crosspost[client_key]', @mastodon.client_key, id: 'verify_client_key_mastodon' %>
      <%= hidden_field_tag 'crosspost[client_secret]', @mastodon.client_secret, id: 'verify_client_secret_mastodon' %>
      <%= hidden_field_tag 'crosspost[access_token]', @mastodon.access_token, id: 'verify_access_token_mastodon' %>
    <% end %>
    <div id="verify-messages-mastodon"></div>
  </div>

  <div class="form-section compact">
    <h3>X (Twitter)</h3>
    <small>First, obtain X credentials from <%= link_to "https://developer.x.com", "https://developer.x.com", target: "_blank" %></small>
    
    <%= form_with(model: @twitter, url: admin_crosspost_path(@twitter.platform), method: :patch) do |f| %>
      <%= f.hidden_field :platform, value: 'twitter' %>

      <div class="field checkbox">
        <%= f.check_box :enabled, id: 'crosspost_enabled_twitter' %>
        <%= f.label :enabled, "Enable X CrossPost", for: 'crosspost_enabled_twitter' %>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <%= f.label :access_token, "Access Token" %>
          <%= f.text_field :access_token %>
        </div>

        <div class="field">
          <%= f.label :access_token_secret, "Access Token Secret" %>
          <%= f.text_field :access_token_secret %>
        </div>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <%= f.label :api_key, "API Key" %>
          <%= f.text_field :api_key %>
        </div>

        <div class="field">
          <%= f.label :api_key_secret, "API Key Secret" %>
          <%= f.text_field :api_key_secret %>
        </div>
      </div>

      <div class="form-actions">
        <%= f.submit "Save", class: 'btn btn-primary' %>
        <div id="verify-button-twitter">
          <%= button_tag "Verify", type: 'submit', class: 'btn btn-secondary', form: "verify-form-twitter", data: { turbo_frame: "_top" } %>
        </div>
      </div>
    <% end %>

    <%= form_with(url: verify_admin_crosspost_path('twitter'), method: :post, data: { turbo: true }, id: "verify-form-twitter") do |vf| %>
      <%= hidden_field_tag 'crosspost[platform]', 'twitter' %>
      <%= hidden_field_tag 'crosspost[access_token]', @twitter.access_token, id: 'verify_access_token_twitter' %>
      <%= hidden_field_tag 'crosspost[access_token_secret]', @twitter.access_token_secret, id: 'verify_access_token_secret_twitter' %>
      <%= hidden_field_tag 'crosspost[api_key]', @twitter.api_key, id: 'verify_api_key_twitter' %>
      <%= hidden_field_tag 'crosspost[api_key_secret]', @twitter.api_key_secret, id: 'verify_api_key_secret_twitter' %>
    <% end %>
    <div id="verify-messages-twitter"></div>
  </div>

  <div class="form-section compact">
    <h3>Bluesky</h3>
    <small>Get credentials: Log in to your Bluesky account and generate an App Password in settings.</small>
    
    <%= form_with(model: @bluesky, url: admin_crosspost_path(@bluesky.platform), method: :patch) do |f| %>
      <%= f.hidden_field :platform, value: 'bluesky' %>

      <div class="field checkbox">
        <%= f.check_box :enabled, id: 'crosspost_enabled_bluesky' %>
        <%= f.label :enabled, "Enable Bluesky CrossPost", for: 'crosspost_enabled_bluesky' %>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <%= f.label :username, "Username" %>
          <%= f.text_field :username, placeholder: "your.handle" %>
        </div>

        <div class="field">
          <%= f.label :app_password, "App Password" %>
          <%= f.text_field :app_password %>
        </div>
      </div>

      <div class="field">
        <%= f.label :server_url, "Server URL" %>
        <%= f.text_field :server_url, placeholder: "https://bsky.social/xrpc" %>
      </div>

      <div class="field checkbox">
        <%= f.check_box :auto_fetch_comments %>
        <%= f.label :auto_fetch_comments, "Auto-fetch Comments" %>
      </div>
      <small>Automatically fetch and display comments from Bluesky every day</small>

      <div class="form-actions">
        <%= f.submit "Save", class: 'btn btn-primary' %>
        <div id="verify-button-bluesky">
          <%= button_tag "Verify", type: 'submit', class: 'btn btn-secondary', form: "verify-form-bluesky", data: { turbo_frame: "_top" } %>
        </div>
      </div>
    <% end %>

    <%= form_with(url: verify_admin_crosspost_path('bluesky'), method: :post, data: { turbo: true }, id: "verify-form-bluesky") do |vf| %>
      <%= hidden_field_tag 'crosspost[platform]', 'bluesky' %>
      <%= hidden_field_tag 'crosspost[username]', @bluesky.username, id: 'verify_username_bluesky' %>
      <%= hidden_field_tag 'crosspost[app_password]', @bluesky.app_password, id: 'verify_app_password_bluesky' %>
      <%= hidden_field_tag 'crosspost[server_url]', @bluesky.server_url, id: 'verify_server_url_bluesky' %>
    <% end %>
    <div id="verify-messages-bluesky"></div>
  </div>

  <div class="form-section compact">
    <h3>Internet Archive</h3>
    <small>Automatically archive your articles to the Internet Archive's Wayback Machine. No credentials required.</small>
    
    <%= form_with(model: @internet_archive, url: admin_crosspost_path(@internet_archive.platform), method: :patch) do |f| %>
      <%= f.hidden_field :platform, value: 'internet_archive' %>

      <div class="field checkbox">
        <%= f.check_box :enabled, id: 'crosspost_enabled_internet_archive' %>
        <%= f.label :enabled, "Enable Internet Archive CrossPost", for: 'crosspost_enabled_internet_archive' %>
      </div>

      <div class="form-actions">
        <%= f.submit "Save", class: 'btn btn-primary' %>
        <div id="verify-button-internet_archive">
          <%= button_tag "Verify", type: 'submit', class: 'btn btn-secondary', form: "verify-form-internet_archive", data: { turbo_frame: "_top" } %>
        </div>
      </div>
    <% end %>

    <%= form_with(url: verify_admin_crosspost_path('internet_archive'), method: :post, data: { turbo: true }, id: "verify-form-internet_archive") do |vf| %>
      <%= hidden_field_tag 'crosspost[platform]', 'internet_archive' %>
    <% end %>
    <div id="verify-messages-internet_archive"></div>
  </div>

  <div class="form-section">
    <h3>Activity History</h3>
    <%= render 'admin/shared/activitylog', activity_logs: @activity_logs %>
  </div>
</div>

<% content_for :javascript do %>
<script>
(function() {
  // 使用立即执行函数避免重复绑定
  let initialized = false;

  function initFormSync() {
    if (initialized) return;
    initialized = true;

    // 同步主表单的值到 verify 表单
    function syncFormValues(platform) {
      const mainForm = document.querySelector(`form[action*="/admin/crossposts/${platform}"][method="patch"]`);
      if (!mainForm) return;

      const verifyForm = document.getElementById(`verify-form-${platform}`);
      if (!verifyForm) return;

      // 获取主表单的所有字段值
      const formData = new FormData(mainForm);
      formData.forEach((value, key) => {
        if (key.startsWith('crosspost[')) {
          const fieldName = key.replace('crosspost[', '').replace(']', '');
          const verifyField = verifyForm.querySelector(`[name="crosspost[${fieldName}]"]`);
          if (verifyField) {
            verifyField.value = value;
          }
        }
      });
    }

    // 为每个平台设置表单同步
    ['mastodon', 'twitter', 'bluesky', 'internet_archive'].forEach(platform => {
      const mainForm = document.querySelector(`form[action*="/admin/crossposts/${platform}"][method="patch"]`);
      if (mainForm) {
        // 使用事件委托，避免重复绑定
        mainForm.addEventListener('input', () => syncFormValues(platform), { once: false });
        mainForm.addEventListener('change', () => syncFormValues(platform), { once: false });
        
        // 在 verify 表单提交前同步值
        const verifyForm = document.getElementById(`verify-form-${platform}`);
        if (verifyForm) {
          verifyForm.addEventListener('submit', (e) => {
            syncFormValues(platform);
          }, { once: false });
        }
      }
    });
  }

  // 在页面加载时初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFormSync);
  } else {
    initFormSync();
  }

  // 支持 Turbo
  document.addEventListener('turbo:load', function() {
    initialized = false;
    initFormSync();
  });
})();
</script>
<% end %>
