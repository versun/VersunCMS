<% # Shared batch form submission handler %>
<script nonce="<%= content_security_policy_nonce %>">
function submitBatchForm(button, action) {
  const form = button.closest('form');
  const controller = document.querySelector('[data-controller="batch-selection"]');
  const checkboxes = controller.querySelectorAll('input[type="checkbox"][data-batch-selection-target="checkbox"]:checked');
  
  if (checkboxes.length === 0) {
    alert('Please select at least one item.');
    return false;
  }

  // Clear existing hidden inputs
  form.querySelectorAll('input[name="ids[]"]').forEach(input => input.remove());
  
  // Add selected IDs as hidden inputs
  checkboxes.forEach(checkbox => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'ids[]';
    input.value = checkbox.value;
    form.appendChild(input);
  });

  if (action === 'delete' && !confirm(`Are you sure you want to delete ${checkboxes.length} item(s)?`)) {
    return false;
  }

  return true;
}

function submitBatchFormWithModal(button, formId) {
  const form = document.getElementById(formId);
  const controller = document.querySelector('[data-controller="batch-selection"]');
  const checkboxes = controller.querySelectorAll('input[type="checkbox"][data-batch-selection-target="checkbox"]:checked');
  
  if (checkboxes.length === 0) {
    alert('请至少选择一个文章。');
    return false;
  }

  // Clear existing hidden inputs
  form.querySelectorAll('input[name="ids[]"]').forEach(input => input.remove());
  
  // Add selected IDs as hidden inputs
  checkboxes.forEach(checkbox => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'ids[]';
    input.value = checkbox.value;
    form.appendChild(input);
  });

  return true;
}

function openBatchAddTagsModal() {
  const controller = document.querySelector('[data-controller="batch-selection"]');
  const checkboxes = controller.querySelectorAll('input[type="checkbox"][data-batch-selection-target="checkbox"]:checked');
  
  if (checkboxes.length === 0) {
    alert('请至少选择一个文章。');
    return;
  }
  
  document.getElementById('batchAddTagsModal').style.display = 'block';
}

function closeBatchAddTagsModal() {
  document.getElementById('batchAddTagsModal').style.display = 'none';
  document.getElementById('batchAddTagsForm').querySelector('input[name="tag_names"]').value = '';
}

function openBatchCrosspostModal() {
  const controller = document.querySelector('[data-controller="batch-selection"]');
  const checkboxes = controller.querySelectorAll('input[type="checkbox"][data-batch-selection-target="checkbox"]:checked');
  
  if (checkboxes.length === 0) {
    alert('请至少选择一个文章。');
    return;
  }
  
  // Reset checkboxes
  document.querySelectorAll('#batchCrosspostForm input[type="checkbox"]').forEach(cb => cb.checked = false);
  document.getElementById('batchCrosspostModal').style.display = 'block';
}

function closeBatchCrosspostModal() {
  document.getElementById('batchCrosspostModal').style.display = 'none';
  document.querySelectorAll('#batchCrosspostForm input[type="checkbox"]').forEach(cb => cb.checked = false);
}

function openBatchNewsletterModal() {
  const controller = document.querySelector('[data-controller="batch-selection"]');
  const checkboxes = controller.querySelectorAll('input[type="checkbox"][data-batch-selection-target="checkbox"]:checked');
  
  if (checkboxes.length === 0) {
    alert('请至少选择一个文章。');
    return;
  }
  
  document.getElementById('batchNewsletterModal').style.display = 'block';
}

function closeBatchNewsletterModal() {
  document.getElementById('batchNewsletterModal').style.display = 'none';
}

if (!window.batchFormHandlersInitialized) {
  window.batchFormHandlersInitialized = true;

  document.addEventListener('click', function(event) {
    const actionButton = event.target.closest('[data-batch-action]');
    if (actionButton) {
      const action = actionButton.dataset.batchAction;
      if (!submitBatchForm(actionButton, action)) {
        event.preventDefault();
      }
      return;
    }

    const modalSubmitButton = event.target.closest('[data-batch-modal-submit]');
    if (modalSubmitButton) {
      const formId = modalSubmitButton.dataset.batchModalSubmit;
      if (!submitBatchFormWithModal(modalSubmitButton, formId)) {
        event.preventDefault();
      }
      return;
    }

    const modalOpenButton = event.target.closest('[data-batch-modal-open]');
    if (modalOpenButton) {
      const target = modalOpenButton.dataset.batchModalOpen;
      if (target === 'add-tags') openBatchAddTagsModal();
      if (target === 'crosspost') openBatchCrosspostModal();
      if (target === 'newsletter') openBatchNewsletterModal();
      return;
    }

    const modalCloseButton = event.target.closest('[data-batch-modal-close]');
    if (modalCloseButton) {
      const target = modalCloseButton.dataset.batchModalClose;
      if (target === 'add-tags') closeBatchAddTagsModal();
      if (target === 'crosspost') closeBatchCrosspostModal();
      if (target === 'newsletter') closeBatchNewsletterModal();
    }
  });
}

// Close modals when clicking outside
window.onclick = function(event) {
  const addTagsModal = document.getElementById('batchAddTagsModal');
  const crosspostModal = document.getElementById('batchCrosspostModal');
  const newsletterModal = document.getElementById('batchNewsletterModal');
  
  if (event.target == addTagsModal) {
    closeBatchAddTagsModal();
  }
  if (event.target == crosspostModal) {
    closeBatchCrosspostModal();
  }
  if (event.target == newsletterModal) {
    closeBatchNewsletterModal();
  }
}
</script>
