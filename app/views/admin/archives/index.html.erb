<% content_for :title, "Web Archive|Admin" %>

<div class="admin-container" data-controller="archive">
  <h1>Web Archive</h1>
  <p class="text-muted">使用 single-file-cli 归档网页并存储到 Git 仓库。</p>

  <!-- Settings Section -->
  <div class="form-section">
    <h2>归档设置</h2>

    <%= form_with(model: @archive_setting, url: update_settings_admin_archives_path, method: :patch) do |f| %>
      <div class="field checkbox">
        <%= f.check_box :enabled %>
        <%= f.label :enabled, "启用网页归档" %>
      </div>

      <div class="field">
        <%= f.label :git_integration_id, "Git 提供商" %>
        <% if @git_integrations.any? %>
          <%= f.select :git_integration_id,
              @git_integrations.map { |gi| [gi.display_name, gi.id] },
              { include_blank: "选择 Git 提供商..." } %>
        <% else %>
          <p class="text-warning">
            未配置任何 Git 集成。
            <%= link_to "配置 Git 集成", admin_git_integrations_path %>
          </p>
          <%= f.hidden_field :git_integration_id %>
        <% end %>
      </div>

      <div class="field">
        <%= f.label :repo_url, "仓库 URL" %>
        <%= f.text_field :repo_url, placeholder: "https://github.com/username/archive-repo.git" %>
        <small>用于存储归档文件的 Git 仓库地址</small>
      </div>

      <div class="field">
        <%= f.label :branch, "分支" %>
        <%= f.text_field :branch, placeholder: "main" %>
      </div>

      <h3>自动归档选项</h3>

      <div class="field checkbox">
        <%= f.check_box :auto_archive_published_articles %>
        <%= f.label :auto_archive_published_articles, "归档已发布的文章 URL" %>
        <small>在文章发布时自动归档文章页面</small>
      </div>

      <div class="field checkbox">
        <%= f.check_box :auto_archive_article_links %>
        <%= f.label :auto_archive_article_links, "归档文章内的链接" %>
        <small>提取并归档文章内容和 source_url 中的所有链接</small>
      </div>

      <div class="field checkbox">
        <%= f.check_box :auto_submit_to_archive_org, id: "auto_submit_to_archive_org" %>
        <%= f.label :auto_submit_to_archive_org, "上传到 Archive.org" %>
        <small>同时将 single-file 生成的 HTML 文件上传到 Internet Archive</small>
      </div>

      <fieldset id="ia-credentials" <%= 'disabled' unless @archive_setting.auto_submit_to_archive_org? %>>
        <legend>Internet Archive S3 凭据</legend>
        <p class="text-muted">
          从 <a href="https://archive.org/account/s3.php" target="_blank">archive.org/account/s3.php</a> 获取 S3 API 密钥
        </p>

        <div class="form-grid form-grid-2">
          <div class="field">
            <%= f.label :ia_access_key, "Access Key" %>
            <%= f.text_field :ia_access_key, placeholder: "Your S3 Access Key" %>
          </div>

          <div class="field">
            <%= f.label :ia_secret_key, "Secret Key" %>
            <%= f.password_field :ia_secret_key, placeholder: "Your S3 Secret Key" %>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" data-action="click->archive#verifyIa">
            验证 S3 凭据
          </button>
          <span id="verify-ia-status" data-archive-target="verifyIaStatus"></span>
        </div>
      </fieldset>

      <div class="form-actions">
        <%= f.submit "保存设置", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>

  <!-- Manual Archive Section -->
  <div class="form-section">
    <h2>手动归档 URL</h2>

    <%= form_with url: admin_archives_path, method: :post do |f| %>
      <div class="field">
        <%= f.label :url, "URL" %>
        <%= f.text_field :url, placeholder: "https://example.com/page-to-archive" %>
      </div>

      <div class="field">
        <%= f.label :title, "标题（可选）" %>
        <%= f.text_field :title, placeholder: "页面标题" %>
      </div>

      <div class="form-actions">
        <%= f.submit "加入归档队列", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>

  <!-- Archive Items List -->
  <div class="form-section">
    <h2>归档记录 (<%= ArchiveItem.count %>)</h2>

    <% if @archive_items.any? %>
      <table class="data-table">
        <thead>
          <tr>
            <th>标题 / URL</th>
            <th>状态</th>
            <th>大小</th>
            <th>归档时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <% @archive_items.each do |item| %>
            <tr>
              <td>
                <div><strong><%= item.title.presence || "无标题" %></strong></div>
                <div class="text-muted"><%= truncate(item.url, length: 60) %></div>
                <% if item.article %>
                  <div class="text-muted">
                    <small>来自: <%= link_to item.article.title, edit_admin_article_path(item.article) %></small>
                  </div>
                <% end %>
              </td>
              <td>
                <span class="status-badge status-<%= item.status %>">
                  <%= case item.status
                      when "pending" then "等待中"
                      when "processing" then "处理中"
                      when "completed" then "已完成"
                      when "failed" then "失败"
                      else item.status
                      end %>
                </span>
                <% if item.error_message.present? %>
                  <div class="text-danger"><small><%= truncate(item.error_message, length: 50) %></small></div>
                <% end %>
              </td>
              <td><%= item.file_size_formatted || "-" %></td>
              <td><%= item.archived_at&.strftime("%Y-%m-%d %H:%M") || "-" %></td>
              <td>
                <% if item.failed? %>
                  <%= button_to "重试", retry_admin_archive_path(item), method: :post, class: "btn btn-sm btn-secondary" %>
                <% end %>
                <%= button_to "删除", admin_archive_path(item), method: :delete, class: "btn btn-sm btn-danger",
                    data: { turbo_confirm: "确定要删除这条归档记录吗？" } %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>

      <%= will_paginate @archive_items, renderer: WillPaginate::ActionView::LinkRenderer %>
    <% else %>
      <p class="text-muted">暂无归档记录。</p>
    <% end %>
  </div>
</div>

<style>
.status-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}
.status-pending { background: #fef3cd; color: #856404; }
.status-processing { background: #cce5ff; color: #004085; }
.status-completed { background: #d4edda; color: #155724; }
.status-failed { background: #f8d7da; color: #721c24; }

#ia-credentials {
  margin-top: 1rem;
  padding: 1rem;
  border: 1px solid #ddd;
  border-radius: 4px;
}
#ia-credentials legend {
  font-weight: 600;
  padding: 0 0.5rem;
}
#ia-credentials:disabled {
  opacity: 0.5;
  background-color: #f5f5f5;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const checkbox = document.getElementById('auto_submit_to_archive_org');
  const credentials = document.getElementById('ia-credentials');

  if (checkbox && credentials) {
    checkbox.addEventListener('change', function() {
      credentials.disabled = !this.checked;
    });
  }
});

document.addEventListener('turbo:load', function() {
  const checkbox = document.getElementById('auto_submit_to_archive_org');
  const credentials = document.getElementById('ia-credentials');

  if (checkbox && credentials) {
    checkbox.addEventListener('change', function() {
      credentials.disabled = !this.checked;
    });
  }
});
</script>
