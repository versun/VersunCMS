<% content_for :title do %>
  <%= @article.seo_meta_title %> | <%= site_settings[:title] %>
<% end %>

<% content_for :head do %>
  <% 
    # 构建文章完整URL
    site_url = site_settings[:url].presence || "https://example.com"
    site_url = site_url.chomp("/")
    site_url = "https://#{site_url}" unless site_url.match?(%r{^https?://})
    article_route_prefix = Rails.application.config.x.article_route_prefix 
    if article_route_prefix.present?
      article_full_url = "#{site_url}/#{article_route_prefix}/#{@article.slug}.html"
    else
      article_full_url = "#{site_url}/#{@article.slug}.html"
    end
    
    meta_title = @article.seo_meta_title
    meta_description = @article.seo_meta_description
    meta_image = @article.seo_meta_image
    
    # 如果 meta_image 是相对路径，转换为绝对路径
    if meta_image.present? && !meta_image.match?(%r{^https?://})
      meta_image = "#{site_url}#{meta_image}" unless meta_image.start_with?("/")
    end
  %>
  
  <!-- Basic Meta Tags -->
  <meta name="description" content="<%= meta_description %>">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="<%= article_full_url %>">
  <meta property="og:title" content="<%= meta_title %>">
  <meta property="og:description" content="<%= meta_description %>">
  <% if meta_image.present? %>
    <meta property="og:image" content="<%= meta_image %>">
  <% end %>
  <meta property="og:site_name" content="<%= site_settings[:title] %>">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="<%= article_full_url %>">
  <meta name="twitter:title" content="<%= meta_title %>">
  <meta name="twitter:description" content="<%= meta_description %>">
  <% if meta_image.present? %>
    <meta name="twitter:image" content="<%= meta_image %>">
  <% end %>
  
  <!-- Article specific meta -->
  <meta property="article:published_time" content="<%= @article.created_at.iso8601 %>">
  <meta property="article:modified_time" content="<%= @article.updated_at.iso8601 %>">
  <% @article.tags.each do |tag| %>
    <meta property="article:tag" content="<%= tag.name %>">
  <% end %>
<% end %>

<article>
  <% 
    # 构建文章完整URL
    site_url = site_settings[:url].presence || "https://example.com"
    site_url = site_url.chomp("/")
    site_url = "https://#{site_url}" unless site_url.match?(%r{^https?://})
    article_route_prefix = Rails.application.config.x.article_route_prefix 
    if article_route_prefix.present?
      article_full_url = "#{site_url}/#{article_route_prefix}/#{@article.slug}.html"
    else
      article_full_url = "#{site_url}/#{@article.slug}.html"
    end
  %>
  <div class="article-header" style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 0.25rem;">
    <h2 style="flex: 1; margin: 0;"><%= @article.title %></h2>
  </div>
  <small style="color:grey; display: block; margin-bottom: 1rem;">
  <% if @article.social_media_posts.any? %>
      <span class="social-label">also posted on:</span>
      <% @article.social_media_posts.each do |post| %>
        <% if post.url.present? %>
          <% 
            platform_config = site_settings[:social_links]&.dig(post.platform)
            icon_class = platform_config&.dig('icon') || Crosspost::PLATFORM_ICONS[post.platform]
            display_name = platform_config&.dig('name') || post.platform.titleize
          %>
          <a href="<%= post.url %>" target="_blank" rel="noopener noreferrer" class="social-icon-link" title="<%= display_name %>">
            <% if icon_class.present? %>
              <i class="<%= icon_class %>" style="font-size: 16px;"></i>
            <% else %>
              <span style="font-size: 14px;"><%= display_name %></span>
            <% end %>
          </a>
        <% end %>
      <% end %>
      <span>|</span>
  <% end %>
    <span class="share-container" style="position: relative; display: inline-block;">
      <button class="share-button" onclick="toggleShareMenu('<%= @article.id %>')" title="Share Article" style="background: none; border: none; cursor: pointer; padding: 4px; color: grey; border-radius: 4px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px;">
        <span>share</span>
        <i class="fas fa-share-alt" style="font-size: 14px;"></i>
      </button>
      <div id="share-menu-<%= @article.id %>" class="share-menu" style="display: none;">
        <a href="#" onclick="copyToClipboard('<%= article_full_url %>'); return false;" class="share-menu-item">
          <i class="fas fa-link"></i> Copy Link
        </a>
        <a href="https://twitter.com/intent/tweet?url=<%= URI.encode_www_form_component(article_full_url) %>&text=<%= URI.encode_www_form_component(@article.title) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item">
          <i class="fab fa-square-x-twitter"></i> Twitter
        </a>
        <a href="https://mastodon.social/share?text=<%= URI.encode_www_form_component("#{@article.title} #{article_full_url}") %>" target="_blank" rel="noopener noreferrer" class="share-menu-item">
          <i class="fab fa-mastodon"></i> Mastodon
        </a>
        <a href="https://bsky.app/intent/compose?text=<%= URI.encode_www_form_component("#{@article.title} #{article_full_url}") %>" target="_blank" rel="noopener noreferrer" class="share-menu-item">
          <i class="fab fa-square-bluesky"></i> Bluesky
        </a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=<%= URI.encode_www_form_component(article_full_url) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item">
          <i class="fab fa-facebook"></i> Facebook
        </a>
        <a href="https://www.linkedin.com/sharing/share-offsite/?url=<%= URI.encode_www_form_component(article_full_url) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item">
          <i class="fab fa-linkedin"></i> LinkedIn
        </a>
        <a href="https://www.reddit.com/submit?url=<%= URI.encode_www_form_component(article_full_url) %>&title=<%= URI.encode_www_form_component(@article.title) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item">
          <i class="fab fa-reddit"></i> Reddit
        </a>
        <a href="https://wa.me/?text=<%= URI.encode_www_form_component("#{@article.title} #{article_full_url}") %>" target="_blank" rel="noopener noreferrer" class="share-menu-item">
          <i class="fab fa-whatsapp"></i> WhatsApp
        </a>
        <a href="https://t.me/share/url?url=<%= URI.encode_www_form_component(article_full_url) %>&text=<%= URI.encode_www_form_component(@article.title) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item">
          <i class="fab fa-telegram"></i> Telegram
        </a>
        <a href="mailto:?subject=<%= URI.encode_www_form_component(@article.title) %>&body=<%= URI.encode_www_form_component("#{@article.title}\n\n#{article_full_url}") %>" class="share-menu-item">
          <i class="fas fa-envelope"></i> Email
        </a>
      </div>
    </span>
  </small>
  <%= render 'articles/source_reference' %>
  <div class="article-content">
    <%= render_article_content_with_social_cards(@article) %>
  </div>
</article>

<% if @article.comment? %>
<div id="comments-section">
  <% all_comments = [] %>
  <% all_comments += @article.comments.local.approved.top_level.map { |c| { type: 'local', data: c } } %>
  <% all_comments += @article.comments.mastodon.top_level.map { |c| { type: 'mastodon', data: c } } %>
  <% all_comments += @article.comments.bluesky.top_level.map { |c| { type: 'bluesky', data: c } } %>
  <% all_comments += @article.comments.twitter.top_level.map { |c| { type: 'twitter', data: c } } %>

  <% if all_comments.any? %>
    <div style="margin-top: 2rem; margin-bottom: 1.5rem;">
      <% total_count = @article.comments.local.approved.count + @article.comments.mastodon.count + @article.comments.bluesky.count + @article.comments.twitter.count %>
      <h3 style="margin-bottom: 1rem; color: #333; font-size: 1.125rem;">Comments (<%= total_count %>)</h3>
    </div>
    
    <% all_comments.each do |comment_item| %>
      <%= render 'comments/static_comment', comment_item: comment_item %>
    <% end %>
  <% end %>

  <%= render 'comments/static_form', comment: Comment.new %>

  <div class="giscus"></div>
  <%= raw site_settings[:giscus] %>
</div>
<% end %>

<script>
  function toggleShareMenu(articleId) {
    var menu = document.getElementById('share-menu-' + articleId);
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
      alert('Link copied to clipboard!');
    });
  }

  function showReplyForm(commentId) {
    var formContainer = document.getElementById('reply-form-' + commentId);
    if (formContainer) {
      formContainer.style.display = 'block';
      formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      var textarea = formContainer.querySelector('textarea');
      if (textarea) {
        setTimeout(function() { textarea.focus(); }, 100);
      }
    }
  }

  function hideReplyForm(commentId) {
    var formContainer = document.getElementById('reply-form-' + commentId);
    if (formContainer) {
      formContainer.style.display = 'none';
      var form = formContainer.querySelector('form');
      if (form) {
        form.reset();
      }
    }
  }

  // Close share menu when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.share-container')) {
      document.querySelectorAll('.share-menu').forEach(function(menu) {
        menu.style.display = 'none';
      });
    }
  });
</script>
