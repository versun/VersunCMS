<% content_for :title do %>
  <%= @article.title %> | <%= site_settings[:title] %>
<% end %>

<%= turbo_frame_tag "article_#{@article.id}", target: "_top" do %>
<article>
  <% 
    # 构建文章完整URL
    site_url = site_settings[:url].presence || request.base_url
    site_url = site_url.chomp("/")
    site_url = "https://#{site_url}" unless site_url.match?(%r{^https?://})
    article_route_prefix = Rails.application.config.x.article_route_prefix || 'articles'
    article_full_url = "#{site_url}/#{article_route_prefix}/#{@article.slug}"
  %>
  <div class="article-header" style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1rem;">
    <h2 style="flex: 1; margin: 0;"><%= @article.title %></h2>
    <span class="share-container" style="position: relative; display: inline-block; margin-left: 12px; flex-shrink: 0;">
      <button class="share-button" onclick="toggleShareMenu(event)" title="分享文章" style="background: none; border: none; cursor: pointer; padding: 4px; color: grey; border-radius: 4px; transition: all 0.2s;">
        <i class="fas fa-share-alt" style="font-size: 14px;"></i>
      </button>
      <div id="share-menu" class="share-menu" style="display: none;">
        <a href="#" onclick="copyArticleLink(event, '<%= article_full_url %>')" class="share-menu-item">
          <i class="fas fa-link"></i> Copy Link
        </a>
        <a href="https://twitter.com/intent/tweet?url=<%= URI.encode_www_form_component(article_full_url) %>&text=<%= URI.encode_www_form_component(@article.title) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" onclick="closeShareMenu()">
          <i class="fab fa-square-x-twitter"></i> Twitter
        </a>
        <a href="https://mastodon.social/share?text=<%= URI.encode_www_form_component("#{@article.title} #{article_full_url}") %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" onclick="closeShareMenu()">
          <i class="fab fa-mastodon"></i> Mastodon
        </a>
        <a href="https://bsky.app/intent/compose?text=<%= URI.encode_www_form_component("#{@article.title} #{article_full_url}") %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" onclick="closeShareMenu()">
          <i class="fab fa-square-bluesky"></i> Bluesky
        </a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=<%= URI.encode_www_form_component(article_full_url) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" onclick="closeShareMenu()">
          <i class="fab fa-facebook"></i> Facebook
        </a>
        <a href="https://www.linkedin.com/sharing/share-offsite/?url=<%= URI.encode_www_form_component(article_full_url) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" onclick="closeShareMenu()">
          <i class="fab fa-linkedin"></i> LinkedIn
        </a>
        <a href="https://www.reddit.com/submit?url=<%= URI.encode_www_form_component(article_full_url) %>&title=<%= URI.encode_www_form_component(@article.title) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" onclick="closeShareMenu()">
          <i class="fab fa-reddit"></i> Reddit
        </a>
        <a href="https://wa.me/?text=<%= URI.encode_www_form_component("#{@article.title} #{article_full_url}") %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" onclick="closeShareMenu()">
          <i class="fab fa-whatsapp"></i> WhatsApp
        </a>
        <a href="https://t.me/share/url?url=<%= URI.encode_www_form_component(article_full_url) %>&text=<%= URI.encode_www_form_component(@article.title) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" onclick="closeShareMenu()">
          <i class="fab fa-telegram"></i> Telegram
        </a>
        <a href="mailto:?subject=<%= URI.encode_www_form_component(@article.title) %>&body=<%= URI.encode_www_form_component("#{@article.title}\n\n#{article_full_url}") %>" class="share-menu-item" onclick="closeShareMenu()">
          <i class="fas fa-envelope"></i> Email
        </a>
      </div>
    </span>
  </div>
  <small style="color:grey">
  <% if @article.social_media_posts.any? %>
      <span class="social-label">Also posted to:</span>
      <% @article.social_media_posts.each do |post| %>
        <% if post.url.present? %>
          <% 
            # 从 settings 中获取对应平台的图标信息
            platform_config = site_settings[:social_links]&.dig(post.platform)
            icon_class = platform_config&.dig('icon') || Crosspost::PLATFORM_ICONS[post.platform]
            display_name = platform_config&.dig('name') || post.platform.titleize
          %>
          <a href="<%= post.url %>" target="_blank" rel="noopener noreferrer" class="social-icon-link" title="<%= display_name %>">
            <% if icon_class.present? %>
              <i class="<%= icon_class %>" style="font-size: 16px;"></i>
            <% else %>
              <span style="font-size: 14px;"><%= display_name %></span>
            <% end %>
          </a>
        <% end %>
      <% end %>
  <% end %>
  </small>
  <div class="article-content">
    <%= @article.content %>
  </div>
</article>


<div id="comments-section">
  <% # Prepare all comments from all sources - only top level comments %>
  <% all_comments = [] %>
  <% # Local approved top-level comments only %>
  <% all_comments += @article.comments.local.approved.top_level.map do |c| %>
  <%   { type: 'local', data: c } %>
  <% end %>
  <% # External platform comments - only top-level to avoid duplicate rendering %>
  <% all_comments += @article.comments.mastodon.top_level.map { |c| { type: 'mastodon', data: c } } %>
  <% all_comments += @article.comments.bluesky.top_level.map { |c| { type: 'bluesky', data: c } } %>
  <% all_comments += @article.comments.twitter.top_level.map { |c| { type: 'twitter', data: c } } %>

  <% if all_comments.any? %>
    <div style="margin-top: 2rem; margin-bottom: 1.5rem;">
      <% total_count = @article.comments.local.approved.count + @article.comments.mastodon.count + @article.comments.bluesky.count + @article.comments.twitter.count %>
      <h3 style="margin-bottom: 1rem; color: #333; font-size: 1.125rem;">Comments (<%= total_count %>)</h3>
    </div>
    
    <% all_comments.each do |comment_item| %>
      <%= render 'comments/comment', comment_item: comment_item %>
    <% end %>
  <% end %>

  <%= render 'comments/form', comment: Comment.new %>

  <div class="giscus"></div>
  <%= raw site_settings[:giscus] %>
</div>

<script>
  function showReplyForm(commentId) {
    const formContainer = document.getElementById('reply-form-' + commentId);
    if (formContainer) {
      formContainer.style.display = 'block';
      // Scroll to form
      formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      // Focus on textarea
      const textarea = formContainer.querySelector('textarea');
      if (textarea) {
        setTimeout(() => textarea.focus(), 100);
      }
    }
  }

  function hideReplyForm(commentId) {
    const formContainer = document.getElementById('reply-form-' + commentId);
    if (formContainer) {
      formContainer.style.display = 'none';
      // Clear form
      const form = formContainer.querySelector('form');
      if (form) {
        form.reset();
      }
    }
  }

  function toggleShareMenu(event) {
    event.stopPropagation();
    
    // 直接显示社交平台分享菜单
    showShareMenu();
  }
  
  function showShareMenu() {
    const menu = document.getElementById('share-menu');
    const isVisible = menu.style.display === 'block';
    
    // 关闭所有其他分享菜单
    document.querySelectorAll('.share-menu').forEach(m => {
      if (m !== menu) {
        m.style.display = 'none';
      }
    });
    
    menu.style.display = isVisible ? 'none' : 'block';
    
    // 如果菜单显示，添加点击外部关闭的监听器
    if (!isVisible) {
      setTimeout(() => {
        document.addEventListener('click', closeShareMenuOnOutsideClick);
      }, 0);
    } else {
      // 如果菜单隐藏，移除监听器
      document.removeEventListener('click', closeShareMenuOnOutsideClick);
    }
  }

  function closeShareMenu() {
    const menu = document.getElementById('share-menu');
    menu.style.display = 'none';
    document.removeEventListener('click', closeShareMenuOnOutsideClick);
  }

  function closeShareMenuOnOutsideClick(event) {
    const shareContainer = event.target.closest('.share-container');
    if (!shareContainer) {
      closeShareMenu();
    }
  }

  function copyArticleLink(event, url) {
    event.preventDefault();
    event.stopPropagation();
    
    // 使用 Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(url).then(() => {
        showCopySuccess(event.target);
      }).catch(err => {
        console.error('复制失败:', err);
        fallbackCopyTextToClipboard(url, event.target);
      });
    } else {
      fallbackCopyTextToClipboard(url, event.target);
    }
    
    // 关闭菜单
    closeShareMenu();
  }

  function fallbackCopyTextToClipboard(text, target) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        showCopySuccess(target);
      } else {
        alert('复制失败，请手动复制: ' + text);
      }
    } catch (err) {
      console.error('Fallback: 复制失败', err);
      alert('复制失败，请手动复制: ' + text);
    }
    
    document.body.removeChild(textArea);
  }

  function showCopySuccess(target) {
    const originalText = target.innerHTML;
    target.innerHTML = '<i class="fas fa-check"></i> 已复制';
    target.style.color = '#4caf50';
    
    setTimeout(() => {
      target.innerHTML = originalText;
      target.style.color = '';
    }, 2000);
  }
</script>
<% end %>
