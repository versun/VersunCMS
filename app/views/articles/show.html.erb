<% content_for :title do %>
  <%= @article.title %> | <%= site_settings[:title] %>
<% end %>

<%= turbo_frame_tag "article_#{@article.id}", target: "_top" do %>
<article>
  <h2><%= @article.title %></h2>
  <small style="color:grey">
  <% if @article.social_media_posts.any? %>
      <span class="social-label">Also posted to:</span>
      <% @article.social_media_posts.each do |post| %>
        <% if post.url.present? %>
          <% 
            # 从 settings 中获取对应平台的图标信息
            platform_config = site_settings[:social_links]&.dig(post.platform)
            icon_class = platform_config&.dig('icon') || Crosspost::PLATFORM_ICONS[post.platform]
            display_name = platform_config&.dig('name') || post.platform.titleize
          %>
          <a href="<%= post.url %>" target="_blank" rel="noopener noreferrer" class="social-icon-link" title="<%= display_name %>">
            <% if icon_class.present? %>
              <i class="<%= icon_class %>" style="font-size: 16px;"></i>
            <% else %>
              <span style="font-size: 14px;"><%= display_name %></span>
            <% end %>
          </a>
        <% end %>
      <% end %>
  <% end %>
  </small>
  <div class="article-content">
    <%= @article.content %>
  </div>
</article>


<div id="comments-section">
  <% # Prepare all comments from all sources %>
  <% all_comments = [] %>
  <% # Local approved comments %>
  <% all_comments += @article.comments.local.approved.map do |c| %>
  <%   { type: 'local', data: c } %>
  <% end %>
  <% # External platform comments %>
  <% all_comments += @article.comments.mastodon.map { |c| { type: 'mastodon', data: c } } %>
  <% all_comments += @article.comments.bluesky.map { |c| { type: 'bluesky', data: c } } %>
  <% all_comments += @article.comments.twitter.map { |c| { type: 'twitter', data: c } } %>

  <% if all_comments.any? %>
    <div style="margin-top: 3rem; margin-bottom: 2.5rem;">
      <div style="height: 1px; background: linear-gradient(to right, transparent, #ddd 20%, #ddd 80%, transparent); margin-bottom: 2rem;"></div>
      <h3 style="margin-bottom: 1.5rem; color: #333;">Comments (<%= all_comments.size %>)</h3>
    </div>
    
    <% all_comments.each do |comment_item| %>
      <% comment = comment_item[:data] %>
      <% type = comment_item[:type] %>
      
      <% 
        border_color = case type
        when 'mastodon' then '#6364FF'
        when 'bluesky' then '#0085FF'
        when 'twitter' then '#1DA1F2'
        else '#333'
        end
      %>
      
      <div class="comment" style="margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: start; gap: 0.75rem;">
          <% if comment.author_avatar_url.present? %>
            <img src="<%= comment.author_avatar_url %>" alt="<%= comment.author_name %>" style="width: 48px; height: 48px; border-radius: 50%; flex-shrink: 0;">
          <% else %>
            <div style="width: 48px; height: 48px; border-radius: 50%; background-color: <%= border_color %>; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">
              <%= comment.author_name.to_s.first.upcase %>
            </div>
          <% end %>
          
          <div style="flex: 1; min-width: 0;">
            <div style="margin-bottom: 0.5rem;">
              <% if comment.author_url.present? %>
                <strong style="font-size: 1rem; color: #111;"><%= link_to comment.author_name, comment.author_url, target: "_blank", style: "text-decoration: none; color: inherit;" %></strong>
              <% else %>
                <strong style="font-size: 1rem; color: #111;"><%= comment.author_name %></strong>
              <% end %>
              
              <% if type != 'local' && comment.author_username.present? %>
                <span style="color: #666; font-size: 0.9rem; margin-left: 0.25rem;">@<%= comment.author_username %></span>
              <% end %>
              
              <small style="color: #999; margin-left: 0.5rem; font-size: 0.875rem;">
                <%= time_ago_in_words(comment.published_at) %> ago
                <% if type != 'local' %>
                  · <%= link_to type.titleize, comment.url, target: "_blank", style: "color: #{border_color}; text-decoration: none;" %>
                <% end %>
              </small>
            </div>
            
            <div style="background-color: #f5f3f0; border-radius: 8px; padding: 0.75rem 1rem; margin-top: 0.5rem; color: #333; line-height: 1.6;">
              <%= sanitize comment.content, tags: %w[p br a span], attributes: %w[href class rel target] %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <%= render 'comments/form', comment: Comment.new %>

  <div class="giscus"></div>
  <%= raw site_settings[:giscus] %>
</div>
<% end %>
