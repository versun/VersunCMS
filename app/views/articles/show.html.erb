<% content_for :title do %>
  <%= @article.title %> | <%= site_settings[:title] %>
<% end %>

<%= turbo_frame_tag "article_#{@article.id}", target: "_top" do %>
<article>
  <h2><%= @article.title %></h2>
  <small style="color:grey">
  <% if @article.social_media_posts.any? %>
      <span class="social-label">Also posted to:</span>
      <% @article.social_media_posts.each do |post| %>
        <% if post.url.present? %>
          <% 
            # 从 settings 中获取对应平台的图标信息
            platform_config = site_settings[:social_links]&.dig(post.platform)
            icon_class = platform_config&.dig('icon') || Crosspost::PLATFORM_ICONS[post.platform]
            display_name = platform_config&.dig('name') || post.platform.titleize
          %>
          <a href="<%= post.url %>" target="_blank" rel="noopener noreferrer" class="social-icon-link" title="<%= display_name %>">
            <% if icon_class.present? %>
              <i class="<%= icon_class %>" style="font-size: 16px;"></i>
            <% else %>
              <span style="font-size: 14px;"><%= display_name %></span>
            <% end %>
          </a>
        <% end %>
      <% end %>
  <% end %>
  </small>
  <div class="article-content">
    <%= @article.content %>
  </div>
</article>


<div id="comments-section">
  <% # Prepare all comments from all sources - only top level comments %>
  <% all_comments = [] %>
  <% # Local approved top-level comments only %>
  <% all_comments += @article.comments.local.approved.top_level.map do |c| %>
  <%   { type: 'local', data: c } %>
  <% end %>
  <% # External platform comments - only top-level to avoid duplicate rendering %>
  <% all_comments += @article.comments.mastodon.top_level.map { |c| { type: 'mastodon', data: c } } %>
  <% all_comments += @article.comments.bluesky.top_level.map { |c| { type: 'bluesky', data: c } } %>
  <% all_comments += @article.comments.twitter.top_level.map { |c| { type: 'twitter', data: c } } %>

  <% if all_comments.any? %>
    <div style="margin-top: 2rem; margin-bottom: 1.5rem;">
      <% total_count = @article.comments.local.approved.count + @article.comments.mastodon.count + @article.comments.bluesky.count + @article.comments.twitter.count %>
      <h3 style="margin-bottom: 1rem; color: #333; font-size: 1.125rem;">Comments (<%= total_count %>)</h3>
    </div>
    
    <% all_comments.each do |comment_item| %>
      <%= render 'comments/comment', comment_item: comment_item %>
    <% end %>
  <% end %>

  <%= render 'comments/form', comment: Comment.new %>

  <div class="giscus"></div>
  <%= raw site_settings[:giscus] %>
</div>

<script>
  function showReplyForm(commentId) {
    const formContainer = document.getElementById('reply-form-' + commentId);
    if (formContainer) {
      formContainer.style.display = 'block';
      // Scroll to form
      formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      // Focus on textarea
      const textarea = formContainer.querySelector('textarea');
      if (textarea) {
        setTimeout(() => textarea.focus(), 100);
      }
    }
  }

  function hideReplyForm(commentId) {
    const formContainer = document.getElementById('reply-form-' + commentId);
    if (formContainer) {
      formContainer.style.display = 'none';
      // Clear form
      const form = formContainer.querySelector('form');
      if (form) {
        form.reset();
      }
    }
  }
</script>
<% end %>
