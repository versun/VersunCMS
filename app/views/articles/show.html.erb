<% content_for :title do %>
  <%= @article.seo_meta_title %> | <%= site_settings[:title] %>
<% end %>

<% content_for :head do %>
  <% 
    # 构建文章完整URL
    site_url = normalized_site_url
    article_full_url = "#{site_url}#{article_path(@article)}"
    
    meta_title = @article.seo_meta_title
    meta_description = @article.seo_meta_description
    meta_image = @article.seo_meta_image
    
    # 如果 meta_image 是相对路径，转换为绝对路径
    if meta_image.present? && !meta_image.match?(%r{^https?://})
      meta_image = "#{site_url}#{meta_image}" unless meta_image.start_with?("/")
    end
  %>
  
  <!-- Basic Meta Tags -->
  <meta name="description" content="<%= meta_description %>">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="<%= article_full_url %>">
  <meta property="og:title" content="<%= meta_title %>">
  <meta property="og:description" content="<%= meta_description %>">
  <% if meta_image.present? %>
    <meta property="og:image" content="<%= meta_image %>">
  <% end %>
  <meta property="og:site_name" content="<%= site_settings[:title] %>">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="<%= article_full_url %>">
  <meta name="twitter:title" content="<%= meta_title %>">
  <meta name="twitter:description" content="<%= meta_description %>">
  <% if meta_image.present? %>
    <meta name="twitter:image" content="<%= meta_image %>">
  <% end %>
  
  <!-- Article specific meta -->
  <meta property="article:published_time" content="<%= @article.created_at.iso8601 %>">
  <meta property="article:modified_time" content="<%= @article.updated_at.iso8601 %>">
  <% @article.tags.each do |tag| %>
    <meta property="article:tag" content="<%= tag.name %>">
  <% end %>
<% end %>

<article>
  <% 
    # 构建文章完整URL
    site_url = normalized_site_url
    article_full_url = "#{site_url}#{article_path(@article)}"
  %>
  <div class="article-header">
    <h2><%= @article.title %></h2>
  </div>
  <small class="article-meta">
  <% social_posts = @article.social_media_posts.select { |post| Crosspost::PLATFORMS.include?(post.platform) } %>
  <% if social_posts.any? %>
      <span class="social-label">also posted on:</span>
      <% social_posts.each do |post| %>
        <% if post.url.present? %>
          <%
            # 从 settings 中获取对应平台的图标信息
            platform_config = site_settings[:social_links]&.dig(post.platform)
            icon_class = platform_config&.dig('icon') || Crosspost::PLATFORM_ICONS[post.platform]
            display_name = platform_config&.dig('name') || post.platform.titleize
            icon_key = icon_class.to_s
            icon_svg = icon_key.start_with?("svg:") ? icon_key.delete_prefix("svg:") : nil
          %>
          <a href="<%= post.url %>" target="_blank" rel="noopener noreferrer" class="social-icon-link" title="<%= display_name %>">
            <% if icon_svg.present? %>
              <%= image_tag "icons/#{icon_svg}.svg", class: "inline-svg-icon", alt: "#{display_name} icon" %>
            <% elsif icon_class.present? %>
              <i class="<%= icon_class %>" style="font-size: 16px;"></i>
            <% else %>
              <span style="font-size: 14px;"><%= display_name %></span>
            <% end %>
          </a>
        <% end %>
      <% end %>
      <span class="article-meta-divider">|</span>
  <% end %>
    <span class="share-container" data-controller="share" data-share-url-value="<%= article_full_url %>">
      <button class="share-button" data-action="click->share#toggle" title="Share Article">
        <span>share</span>
        <i class="fas fa-share-alt" style="font-size: 14px;"></i>
      </button>
      <div id="share-menu-<%= @article.id %>" class="share-menu" data-share-target="menu" style="display: none;">
        <a href="#" data-action="click->share#copy" class="share-menu-item">
          <i class="fas fa-link"></i> Copy Link
        </a>
        <a href="https://twitter.com/intent/tweet?url=<%= URI.encode_www_form_component(article_full_url) %>&text=<%= URI.encode_www_form_component(@article.title) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" data-action="click->share#close">
          <i class="fab fa-square-x-twitter"></i> Twitter
        </a>
        <a href="https://mastodon.social/share?text=<%= URI.encode_www_form_component("#{@article.title} #{article_full_url}") %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" data-action="click->share#close">
          <i class="fab fa-mastodon"></i> Mastodon
        </a>
        <a href="https://bsky.app/intent/compose?text=<%= URI.encode_www_form_component("#{@article.title} #{article_full_url}") %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" data-action="click->share#close">
          <i class="fab fa-square-bluesky"></i> Bluesky
        </a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=<%= URI.encode_www_form_component(article_full_url) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" data-action="click->share#close">
          <i class="fab fa-facebook"></i> Facebook
        </a>
        <a href="https://www.linkedin.com/sharing/share-offsite/?url=<%= URI.encode_www_form_component(article_full_url) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" data-action="click->share#close">
          <i class="fab fa-linkedin"></i> LinkedIn
        </a>
        <a href="https://www.reddit.com/submit?url=<%= URI.encode_www_form_component(article_full_url) %>&title=<%= URI.encode_www_form_component(@article.title) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" data-action="click->share#close">
          <i class="fab fa-reddit"></i> Reddit
        </a>
        <a href="https://wa.me/?text=<%= URI.encode_www_form_component("#{@article.title} #{article_full_url}") %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" data-action="click->share#close">
          <i class="fab fa-whatsapp"></i> WhatsApp
        </a>
        <a href="https://t.me/share/url?url=<%= URI.encode_www_form_component(article_full_url) %>&text=<%= URI.encode_www_form_component(@article.title) %>" target="_blank" rel="noopener noreferrer" class="share-menu-item" data-action="click->share#close">
          <i class="fab fa-telegram"></i> Telegram
        </a>
        <a href="mailto:?subject=<%= URI.encode_www_form_component(@article.title) %>&body=<%= URI.encode_www_form_component("#{@article.title}\n\n#{article_full_url}") %>" class="share-menu-item" data-action="click->share#close">
          <i class="fas fa-envelope"></i> Email
        </a>
      </div>
    </span>
  </small>
  <% if @article.has_source? %>
    <%= render 'articles/source_reference' %>
  <% end %>
  <div class="article-content">
    <%= @article.rendered_content %>
  </div>
</article>

<% if @article.comment? %>
<div id="comments-section">
  <% # Use preloaded comments - filter in Ruby to avoid N+1 queries %>
  <% preloaded_comments = @article.comments.to_a %>
  <% all_comments = [] %>

  <% # Local approved top-level comments %>
  <% local_comments = preloaded_comments.select { |c| c.platform.nil? && c.approved? && c.parent_id.nil? } %>
  <% all_comments += local_comments.map { |c| { type: 'local', data: c } } %>

  <% # External platform comments - only top-level %>
  <% mastodon_comments = preloaded_comments.select { |c| c.platform == 'mastodon' && c.parent_id.nil? } %>
  <% bluesky_comments = preloaded_comments.select { |c| c.platform == 'bluesky' && c.parent_id.nil? } %>
  <% twitter_comments = preloaded_comments.select { |c| c.platform == 'twitter' && c.parent_id.nil? } %>

  <% all_comments += mastodon_comments.map { |c| { type: 'mastodon', data: c } } %>
  <% all_comments += bluesky_comments.map { |c| { type: 'bluesky', data: c } } %>
  <% all_comments += twitter_comments.map { |c| { type: 'twitter', data: c } } %>

  <% if all_comments.any? %>
    <div style="margin-top: 2rem; margin-bottom: 1.5rem;">
      <% total_count = preloaded_comments.count { |c| (c.platform.nil? && c.approved?) || c.platform.present? } %>
      <h3 style="margin-bottom: 1rem; color: #333; font-size: 1.125rem;">Comments (<%= total_count %>)</h3>
    </div>
    
    <% all_comments.each do |comment_item| %>
      <%= render 'comments/comment', comment_item: comment_item %>
    <% end %>
  <% end %>

  <%= render 'comments/form', comment: Comment.new %>

  <div class="giscus"></div>
  <%= raw site_settings[:giscus] %>
</div>
<% end %>

<script>
  function showReplyForm(commentId) {
    const formContainer = document.getElementById('reply-form-' + commentId);
    if (formContainer) {
      formContainer.style.display = 'block';
      // Scroll to form
      formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      // Focus on textarea
      const textarea = formContainer.querySelector('textarea');
      if (textarea) {
        setTimeout(() => textarea.focus(), 100);
      }
    }
  }

  function hideReplyForm(commentId) {
    const formContainer = document.getElementById('reply-form-' + commentId);
    if (formContainer) {
      formContainer.style.display = 'none';
      // Clear form
      const form = formContainer.querySelector('form');
      if (form) {
        form.reset();
      }
    }
  }
</script>
