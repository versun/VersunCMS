<!DOCTYPE html>
<html data-controller="theme-toggle">
  <head>
    <title><%= content_for?(:title) ? yield(:title) : site_settings[:title] %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="rails-api-url" content="<%= rails_api_url %>">

    <%= yield :head %>

    <link rel="icon" href="/static/icon.png" type="image/png">
    <link rel="icon" href="/static/icon.svg" type="image/svg+xml">
    <link rel="icon" href="/static/favicon.ico" sizes="32x32">
    <link rel="icon" href="/static/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="/static/favicon.png">
    <link rel="alternate" type="application/rss+xml" title="<%= site_settings[:title] %>" href="/feed.xml">

    <%# Speed up third-party stylesheet fetch (avoid blocking render) %>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    </noscript>

    <%# Critical CSS inlined for faster first paint %>
    <style>
      /* Critical CSS - Layout & First Paint */
      *{box-sizing:border-box;margin:0;padding:0}
      body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:#111;line-height:1.5;font-size:16px;overflow-wrap:break-word}
      img{max-width:100%;height:auto;content-visibility:auto}
      a{text-decoration:none;color:inherit}
      ul{list-style:none}
      .site-container{display:grid;grid-template-columns:180px 1fr;gap:60px;max-width:1000px;margin:60px auto;padding:0 20px}
      .sidebar-header h1{font-size:2rem;font-weight:900;margin-bottom:1rem}
      .sidebar-nav li{margin-top:.5rem}
      .sidebar-nav a{color:#555}
      .sidebar-nav a:hover{color:#000;text-decoration:underline}
      .sidebar-nav a.current{color:#c04000;font-weight:700}
      .social-links,.sidebar-footer{margin-top:2rem}
      .article-list.timeline{display:flex;flex-direction:column;gap:0;position:relative;padding-left:24px}
      .article-list.timeline::before{content:'';position:absolute;left:8px;top:12px;bottom:0;width:1px;background-color:#e0e0e0}
      .timeline-item{display:flex;position:relative;padding-bottom:16px}
      .timeline-marker{position:absolute;left:-20px;top:6px;width:8px;height:8px;border-radius:50%;background-color:#999;border:2px solid #fff;z-index:1}
      .timeline-content{flex:1;min-width:0}
      .timeline-header{display:flex;align-items:center;margin-bottom:4px;gap:8px;flex-wrap:wrap}
      .timeline-date{font-size:.8rem;color:#c04000;font-variant-numeric:tabular-nums;white-space:nowrap}
      .post-title{font-family:Georgia,"Times New Roman",Times,serif;font-size:1.4rem;font-weight:700;color:#111;margin-bottom:4px}
      .post-title a{color:#111}
      .post-title a:hover{color:#c04000;text-decoration:underline}
      .post-description,.post-content{color:#333;font-family:Georgia,"Times New Roman",Times,serif;font-size:1.05rem;line-height:1.6}
      .tag{display:inline-block;background-color:#f0f0f0;color:#666;padding:2px 8px;border-radius:4px;font-size:.85rem}
      footer{display:flex;flex-direction:column;align-items:flex-start;gap:.75rem}
      .footer-text{color:#666;font-size:.875rem;line-height:1.5}
      /* Dark mode critical */
      [data-theme="dark"]{--bg-color:#1a1a1a;--text-color:#f5f5f5;--text-secondary:#d0d0d0;--border-color:#333;--accent-color:#ff6b35}
      [data-theme="dark"] body{background-color:var(--bg-color);color:var(--text-color)}
      [data-theme="dark"] .sidebar-nav a{color:var(--text-secondary)}
      [data-theme="dark"] .post-title,[data-theme="dark"] .post-title a{color:var(--text-color)}
      [data-theme="dark"] .post-content{color:var(--text-color)}
      [data-theme="dark"] .timeline-date{color:var(--accent-color)}
      [data-theme="dark"] .article-list.timeline::before{background-color:var(--border-color)}
      [data-theme="dark"] .timeline-marker{background-color:var(--text-secondary);border-color:var(--bg-color)}
      /* Mobile */
      @media(max-width:768px){.site-container{grid-template-columns:1fr;gap:20px;margin:10px auto;padding:0 15px}.sidebar{text-align:center}.sidebar-nav ul{display:flex;justify-content:center;flex-wrap:wrap;gap:15px}footer{align-items:center}}
    </style>

    <%# Load full CSS asynchronously (non-blocking) - uses static.css without Trix editor styles %>
    <link rel="preload" as="style" href="<%= asset_path('lexxy.css') %>" fetchpriority="high">
    <link rel="preload" as="style" href="<%= asset_path('static.css') %>">
    <%= stylesheet_link_tag "lexxy" %>
    <link rel="stylesheet" href="<%= asset_path('static.css') %>" media="print" onload="this.media='all'">
    <noscript><%= stylesheet_link_tag "static" %></noscript>

    <%= javascript_importmap_tags %>

    <%= raw site_settings[:head_code] %>

    <style>
      <%= site_settings[:custom_css] %>
    </style>
  </head>

  <body>
    <div class="site-container">
      <aside class="sidebar">
        <header class="sidebar-header">
          <h1><a href="/" class="front-page-title"><%= site_settings[:title] %></a></h1>
          <p class="site-description"><%= site_settings[:description] %></p>
        </header>
        <div class="social-links">
            <% if site_settings[:social_links].present? %>
              <% site_settings[:social_links].each do |platform, data| %>
                <% if data['url'].present? %>
                  <% 
                    icon_class = data['icon']
                    display_name = data['name'] || platform.to_s.titleize
                  %>
                  <a rel="me" href="<%= data['url'] %>" target="_blank" class="social" title="<%= display_name %>">
                    <% if icon_class.present? %>
                      <i class="<%= icon_class %>" style="font-size: 20px;"></i>
                    <% end %>
                  </a>
                <% end %>
              <% end %>
            <% end %>
        </div>        
        <nav class="sidebar-nav">
          <%= render 'components/static_nav_bar' %>
        </nav>
        <div class="sidebar-footer">
          <%= render 'components/footer', site_settings: site_settings %>
        </div>
      </aside>

      <main class="main-content">
        <div class="limiter">
          <div id="flash-messages"></div>
          <%= @content_for_layout || yield %>
        </div>
      </main>
      
      <script>
        // Display flash messages from URL parameters (for static pages)
        (function() {
          const urlParams = new URLSearchParams(window.location.search);
          const commentSubmitted = urlParams.get('comment_submitted');
          
          if (commentSubmitted === '1') {
            const flashContainer = document.getElementById('flash-messages');
            if (flashContainer) {
              const message = document.createElement('div');
              message.className = 'flash flash-notice';
              message.style.cssText = 'padding: 1rem; margin-bottom: 1rem; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;';
              message.textContent = '评论已提交，等待审核后显示。';
              flashContainer.appendChild(message);
              
              // Auto-dismiss after 5 seconds
              setTimeout(function() {
                message.style.transition = 'opacity 0.5s';
                message.style.opacity = '0';
                setTimeout(function() {
                  message.remove();
                }, 500);
              }, 5000);
              
              // Remove parameter from URL without reload
              const newUrl = window.location.pathname + (window.location.search.replace(/[?&]comment_submitted=1/, '').replace(/^&/, '?') || '');
              window.history.replaceState({}, '', newUrl);
            }
          }
        })();
      </script>
    </div>

    <%= raw site_settings[:tool_code] %>
    <%= yield :javascript %>
    <%# Client-side redirect fallback for static sites %>
    <script src="/redirects.js" defer></script>
  </body>
</html>

