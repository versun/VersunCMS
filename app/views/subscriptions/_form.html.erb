<%= form_with url: subscriptions_path, local: true, class: "newsletter-subscription-form", data: { controller: "math-captcha", math_captcha_max_value: 10, action: "submit->math-captcha#ensureValid" } do |form| %>
  <% captcha = math_captcha_challenge(max: 10) %>
  <% captcha_answer_id = "subscription-captcha-answer-#{SecureRandom.hex(6)}" %>
  <div class="field">
    <%= form.email_field :email, name: "subscription[email]", placeholder: "输入您的邮箱地址", required: true, class: "newsletter-email-input", data: { action: "focus->math-captcha#show" } %>
  </div>

  <div class="field" data-math-captcha-target="container">
    <label for="<%= captcha_answer_id %>" class="subscription-tags-label">验证：<span data-math-captcha-target="question"><%= captcha[:question] %></span></label>
    <%= text_field_tag "captcha[answer]", nil, id: captcha_answer_id, required: true, inputmode: "numeric", autocomplete: "off", placeholder: "答案", class: "newsletter-email-input", data: { math_captcha_target: "answer", action: "input->math-captcha#validate blur->math-captcha#validate" } %>
    <div data-math-captcha-target="message" class="subscription-tags-label" style="margin-top: 0.25rem; display: none;"></div>
    <%= hidden_field_tag "captcha[a]", captcha[:a], data: { math_captcha_target: "a" } %>
    <%= hidden_field_tag "captcha[b]", captcha[:b], data: { math_captcha_target: "b" } %>
    <%= hidden_field_tag "captcha[op]", captcha[:op], data: { math_captcha_target: "op" } %>
  </div>
  
  <% if Tag.any? %>
    <div class="field">
      <label class="subscription-tags-label">订阅内容（可选，不选择则订阅所有内容）：</label>
      <div class="subscription-tags-container">
        <% Tag.alphabetical.each do |tag| %>
          <div class="subscription-tag-item">
            <%= check_box_tag "subscription[tag_ids][]", tag.id, false, id: "subscription_tag_ids_#{tag.id}", class: "subscription-tag-checkbox" %>
            <%= label_tag "subscription_tag_ids_#{tag.id}", tag.name, class: "subscription-tag-label" %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  
  <%= form.submit "订阅", class: "newsletter-submit-btn" %>
<% end %>
