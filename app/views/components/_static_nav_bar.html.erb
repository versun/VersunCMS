<%# Search form - points to dynamic Rails route %>
<div class="navbar-search">
  <form action="/search.html" method="get" class="search-form">
    <input type="text" name="q" placeholder="搜索..." class="search-input">
  </form>
</div>

<ul>
    <li>
      <a href="/">Home</a>
    </li>
    <li>
      <a href="/tags/">Tags</a>
    </li>
  <% if navbar_items.present? %>
    <% navbar_items.each do |page| %>
      <li>
        <% if page.redirect? %>
          <a href="<%= page.redirect_url %>" target="_blank" rel="noopener"><%= page.title %></a>
        <% else %>
          <a href="/pages/<%= page.slug %>.html"><%= page.title %></a>
        <% end %>
      </li>
    <% end %>     
  <% end %>
</ul>

<%# Newsletter subscription form - posts to dynamic Rails route %>
<% newsletter_setting = NewsletterSetting.instance rescue nil %>
<% if newsletter_setting&.enabled? && newsletter_setting&.native? %>
  <% api_base_url = rails_api_url %>
  <% captcha = math_captcha_challenge(max: 10) %>
  <div class="newsletter-subscription" data-controller="math-captcha" data-math-captcha-max-value="10">
    <div class="newsletter-message" style="display:none; margin-top: 0.5rem; font-size: 0.875rem;"></div>
    <form action="<%= "#{api_base_url}/subscriptions" %>" method="post" class="newsletter-form" data-static-newsletter-form="true">
      <div class="newsletter-form-group">
        <input type="email" name="subscription[email]" placeholder="通过邮件订阅更新" required class="newsletter-email-input" data-action="focus->math-captcha#show">
        <input type="submit" value="订阅" class="newsletter-submit-btn">
      </div>
      <div data-math-captcha-target="container" style="margin-top: 0.5rem;">
        <label style="font-size: 12px; color: #666;">验证：<span data-math-captcha-target="question"><%= captcha[:question] %></span></label>
        <input type="text" name="captcha[answer]" required inputmode="numeric" autocomplete="off" placeholder="答案" style="margin-left: 0.5rem; width: 90px; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" data-math-captcha-target="answer" data-action="input->math-captcha#validate blur->math-captcha#validate">
        <div data-math-captcha-target="message" style="margin-top: 0.25rem; font-size: 12px; display: none;"></div>
        <input type="hidden" name="captcha[a]" value="<%= captcha[:a] %>" data-math-captcha-target="a">
        <input type="hidden" name="captcha[b]" value="<%= captcha[:b] %>" data-math-captcha-target="b">
        <input type="hidden" name="captcha[op]" value="<%= captcha[:op] %>" data-math-captcha-target="op">
      </div>
    </form>
  </div>

  <script>
    (function() {
      const container = document.currentScript && document.currentScript.previousElementSibling;
      if (!container) return;
      const form = container.querySelector('form[data-static-newsletter-form="true"]');
      if (!form) return;

      const messageEl = container.querySelector('.newsletter-message');
      const emailInput = form.querySelector('input[type="email"]');
      const submitBtn = form.querySelector('input[type="submit"]');

      function showMessage(text, type) {
        if (!messageEl) return;
        messageEl.textContent = text;
        messageEl.style.display = 'block';
        messageEl.style.padding = '0.5rem 0.75rem';
        messageEl.style.borderRadius = '4px';
        messageEl.style.border = type === 'error' ? '1px solid #f5c6cb' : '1px solid #c3e6cb';
        messageEl.style.backgroundColor = type === 'error' ? '#f8d7da' : '#d4edda';
        messageEl.style.color = type === 'error' ? '#721c24' : '#155724';

        if (type === 'success') {
          setTimeout(function() {
            messageEl.style.transition = 'opacity 0.3s';
            messageEl.style.opacity = '0';
            setTimeout(function() {
              messageEl.style.display = 'none';
              messageEl.style.opacity = '1';
            }, 350);
          }, 3000);
        }
      }

      form.addEventListener('submit', function(e) {
        e.preventDefault();

        var captchaContainer = form.closest('[data-controller~="math-captcha"]');
        var captchaController = window.Stimulus && captchaContainer
          ? window.Stimulus.getControllerForElementAndIdentifier(captchaContainer, 'math-captcha')
          : null;

        if (captchaController) {
          captchaController.show();
          captchaController.validate();
          if (!captchaController.isValid()) return;
        }

        const email = (emailInput && emailInput.value || '').trim();
        if (!email) {
          showMessage('请输入有效的邮箱地址。', 'error');
          return;
        }

        submitBtn && (submitBtn.disabled = true);
        if (submitBtn) submitBtn.value = '提交中...';

        const formData = new FormData(form);
        fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        })
          .then(function(response) {
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
              return response.json().then(function(data) {
                if (response.ok && data && data.success) {
                  showMessage(data.message || '订阅成功！请检查您的邮箱并点击确认链接。', 'success');
                  if (emailInput) emailInput.value = '';
                } else {
                  showMessage((data && data.message) || '订阅失败，请稍后重试。', 'error');
                }
              });
            }

            if (response.ok) {
              showMessage('订阅成功！请检查您的邮箱并点击确认链接。', 'success');
              if (emailInput) emailInput.value = '';
              return;
            }

            throw new Error('Server returned an error');
          })
          .catch(function() {
            showMessage('订阅失败，请稍后重试。', 'error');
          })
          .finally(function() {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.value = '订阅';
            }
          });
      });
    })();
  </script>
<% end %>
