<% content_for :title do %>
  <%= @page.title %> | <%= site_settings[:title] %>
<% end %>
<article>
  <div class="article-content">
    <% if @page.html? %>
      <%= safe_html_content(@page.html_content) %>
    <% else %>
      <%= @page.content %>
    <% end %>
  </div>
</article>

<% if @page.comment? %>
  <hr>
  <div id="comments-section">
    <% # Use preloaded comments - filter in Ruby %>
    <% preloaded_comments = @page.comments.to_a %>
    <% local_comments = preloaded_comments.select { |c| c.platform.nil? && c.approved? && c.parent_id.nil? } %>

    <% if local_comments.any? %>
      <div style="margin-top: 2rem; margin-bottom: 1.5rem;">
        <% total_count = preloaded_comments.count { |c| c.platform.nil? && c.approved? } %>
        <h3 style="margin-bottom: 1rem; color: #333; font-size: 1.125rem;">Comments (<%= total_count %>)</h3>
      </div>
      
      <% local_comments.each do |comment| %>
        <%= render 'comments/comment', comment_item: { type: 'local', data: comment } %>
      <% end %>
    <% end %>

    <%= render 'comments/form', comment: Comment.new %>
  </div>

  <script>
    function showReplyForm(commentId) {
      const formContainer = document.getElementById('reply-form-' + commentId);
      if (formContainer) {
        formContainer.style.display = 'block';
        // Scroll to form
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        // Focus on textarea
        const textarea = formContainer.querySelector('textarea');
        if (textarea) {
          setTimeout(() => textarea.focus(), 100);
        }
      }
    }

    function hideReplyForm(commentId) {
      const formContainer = document.getElementById('reply-form-' + commentId);
      if (formContainer) {
        formContainer.style.display = 'none';
        // Clear form
        const form = formContainer.querySelector('form');
        if (form) {
          form.reset();
        }
      }
    }
  </script>
<% end %>

<hr>
<div class="giscus"></div>
<%= raw site_settings[:giscus] %>
