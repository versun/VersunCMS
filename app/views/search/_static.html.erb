<% content_for :title do %>
  Search | <%= site_settings[:title] %>
<% end %>

<div style="max-width: 800px; margin: 0 auto; padding: 2rem 1rem;">
  <h2 style="margin-bottom: 0.75rem;">Search</h2>

  <form id="static-search-form" action="/search.html" method="get" style="margin-bottom: 1.25rem;">
    <input id="static-search-input" type="text" name="q" placeholder="搜索..." class="search-input" style="width: 100%; padding: 0.6rem 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
  </form>

  <div id="static-search-status" style="color:#666; font-size: 0.9rem; margin-bottom: 0.75rem;"></div>
  <div id="static-search-results"></div>
</div>

<script>
  (function() {
    const input = document.getElementById('static-search-input');
    const statusEl = document.getElementById('static-search-status');
    const resultsEl = document.getElementById('static-search-results');
    if (!input || !statusEl || !resultsEl) return;

    function getQuery() {
      const params = new URLSearchParams(window.location.search);
      return (params.get('q') || '').trim();
    }

    function escapeHtml(str) {
      return String(str || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function scoreItem(item, qLower) {
      const title = (item.title || '').toLowerCase();
      const desc = (item.description || '').toLowerCase();
      const content = (item.content || '').toLowerCase();
      const tags = Array.isArray(item.tags) ? item.tags.join(' ').toLowerCase() : '';

      let score = 0;
      if (title.includes(qLower)) score += 50;
      if (desc.includes(qLower)) score += 20;
      if (tags.includes(qLower)) score += 10;
      if (content.includes(qLower)) score += 5;
      return score;
    }

    function renderResults(items, query) {
      if (!query) {
        statusEl.textContent = '请输入关键词开始搜索。';
        resultsEl.innerHTML = '';
        return;
      }

      const qLower = query.toLowerCase();
      const scored = items
        .map(function(item) { return { item: item, score: scoreItem(item, qLower) }; })
        .filter(function(x) { return x.score > 0; })
        .sort(function(a, b) { return b.score - a.score; })
        .slice(0, 50);

      statusEl.textContent = scored.length ? ('找到 ' + scored.length + ' 条结果') : '没有找到相关内容。';

      if (!scored.length) {
        resultsEl.innerHTML = '';
        return;
      }

      const html = scored.map(function(x) {
        const item = x.item || {};
        const title = escapeHtml(item.title || '(untitled)');
        const url = escapeHtml(item.url || '#');
        const desc = escapeHtml(item.description || '');
        const tags = Array.isArray(item.tags) ? item.tags : [];

        return (
          '<div style="padding: 0.85rem 0; border-bottom: 1px solid #eee;">' +
            '<div style="font-weight: 600; margin-bottom: 0.25rem;">' +
              '<a href="' + url + '" style="text-decoration: none;">' + title + '</a>' +
            '</div>' +
            (desc ? ('<div style="color:#666; font-size:0.9rem; margin-bottom: 0.35rem;">' + desc + '</div>') : '') +
            (tags.length ? ('<div style="color:#888; font-size:0.85rem;">Tags: ' + escapeHtml(tags.join(', ')) + '</div>') : '') +
          '</div>'
        );
      }).join('');

      resultsEl.innerHTML = html;
    }

    statusEl.textContent = '加载索引中...';

    fetch('/search.json', { headers: { 'Accept': 'application/json' } })
      .then(function(r) {
        if (!r.ok) throw new Error('Failed to load search index');
        return r.json();
      })
      .then(function(items) {
        const q = getQuery();
        input.value = q;
        renderResults(Array.isArray(items) ? items : [], q);

        let t = null;
        input.addEventListener('input', function() {
          clearTimeout(t);
          t = setTimeout(function() {
            const q2 = input.value.trim();
            const url = new URL(window.location.href);
            if (q2) url.searchParams.set('q', q2); else url.searchParams.delete('q');
            window.history.replaceState({}, '', url);
            renderResults(Array.isArray(items) ? items : [], q2);
          }, 120);
        });
      })
      .catch(function() {
        statusEl.textContent = '搜索索引加载失败，请稍后重试。';
      });
  })();
</script>

